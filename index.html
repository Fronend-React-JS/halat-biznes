<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Halat Savdosi Tizimi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, set, get, update, remove, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC6qClFhL8k7RQENOkBipAnT0_q9E3gKz0",
            authDomain: "biznes-8898e.firebaseapp.com",
            databaseURL: "https://biznes-8898e-default-rtdb.asia-southeast1.firebasedatabase.app",  // BU YERGA O'ZGARTIRILDI
            projectId: "biznes-8898e",
            storageBucket: "biznes-8898e.firebasestorage.app",
            messagingSenderId: "443994595724",
            appId: "1:443994595724:web:1e2d3ac9ae115efbde76a9",
            measurementId: "G-3XQ2SKDPXB"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Ma'lumotlar bazasi funksiyalari
        window.DB = {
            save: async function(key, data) {
                try {
                    await set(ref(database, key), data);
                    return true;
                } catch (error) {
                    console.error('Firebase saqlash xatosi:', error);
                    // Agar internet yo'q bo'lsa, localStorage'ga saqlash
                    localStorage.setItem(key, JSON.stringify(data));
                    localStorage.setItem(`${key}_synced`, 'false');
                    return false;
                }
            },
            
            load: async function(key) {
                try {
                    const snapshot = await get(ref(database, key));
                    if (snapshot.exists()) {
                        return snapshot.val();
                    }
                    return null;
                } catch (error) {
                    console.error('Firebase yuklash xatosi:', error);
                    // Agar internet yo'q bo'lsa, localStorage'dan yuklash
                    try {
                        const data = localStorage.getItem(key);
                        return data ? JSON.parse(data) : null;
                    } catch (e) {
                        console.error('LocalStorage yuklash xatosi:', e);
                        return null;
                    }
                }
            },
            
            update: async function(key, updates) {
                try {
                    await update(ref(database, key), updates);
                    return true;
                } catch (error) {
                    console.error('Firebase yangilash xatosi:', error);
                    return false;
                }
            },
            
            remove: async function(key) {
                try {
                    await remove(ref(database, key));
                    return true;
                } catch (error) {
                    console.error('Firebase o\'chirish xatosi:', error);
                    return false;
                }
            },
            
            onDataChange: function(key, callback) {
                const dbRef = ref(database, key);
                onValue(dbRef, (snapshot) => {
                    const data = snapshot.val();
                    callback(data);
                });
            },
            
            // Oflayn rejim uchun sync funksiyasi
            syncOfflineData: async function() {
                const keys = Object.keys(localStorage);
                for (const key of keys) {
                    if (key.endsWith('_synced') && localStorage.getItem(key) === 'false') {
                        const dataKey = key.replace('_synced', '');
                        const data = JSON.parse(localStorage.getItem(dataKey));
                        try {
                            await set(ref(database, dataKey), data);
                            localStorage.setItem(key, 'true');
                            console.log(`${dataKey} ma'lumotlari Firebase'ga sinxronlandi`);
                        } catch (error) {
                            console.error(`${dataKey} sinxronlash xatosi:`, error);
                        }
                    }
                }
            }
        };
        
        console.log('Firebase va ma\'lumotlar bazasi muvaffaqiyatli yuklandi');
    </script>
    
    <style>
        /* Asosiy CSS */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --border: #bdc3c7;
            --background: #f5f7fa;
            --card-bg: #ffffff;
            --text: #333333;
        }
        
        [data-theme="dark"] {
            --primary: #3498db;
            --secondary: #2c3e50;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #34495e;
            --dark: #ecf0f1;
            --border: #4a6278;
            --background: #1a1a2e;
            --card-bg: #16213e;
            --text: #e0e0e0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background);
            color: var(--text);
            min-height: 100vh;
            padding: 5px;
            font-size: 14px;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Kontayner */
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }
        
        /* Sarlavha */
        .header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .header h1 {
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header h1 i {
            font-size: 1.6rem;
        }
        
        /* Navigatsiya uchun tugmalar guruhi */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* Navbar */
        .navbar {
            display: flex;
            background-color: var(--card-bg);
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 12px 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark);
            transition: all 0.3s;
            border-right: 1px solid var(--light);
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            justify-content: center;
            min-width: 90px;
            font-size: 12px;
        }
        
        .nav-btn:hover {
            background-color: var(--light);
        }
        
        .nav-btn.active {
            background-color: var(--secondary);
            color: white;
        }
        
        /* Kartalar */
        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .card-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary);
            padding-bottom: 8px;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Formalar */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
            font-size: 13px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
            background-color: var(--card-bg);
            color: var(--text);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
        }
        
        /* Tugmalar */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        /* Jadval */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .table th {
            background-color: var(--primary);
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--light);
            white-space: nowrap;
        }
        
        .table tr:hover {
            background-color: var(--light);
        }
        
        /* Grid */
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -8px;
        }
        
        .col {
            flex: 1;
            padding: 0 8px;
            min-width: 100%;
        }
        
        /* Statistik kartalar */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: white;
        }
        
        .stat-info h3 {
            font-size: 1.4rem;
            margin-bottom: 3px;
        }
        
        .stat-info p {
            color: #666;
            font-size: 11px;
        }
        
        /* Kirish sahifasi */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
            flex-direction: column;
        }
        
        .login-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 95%;
            width: 100%;
            text-align: center;
        }
        
        .login-card h2 {
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        .user-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .user-type-btn {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            border: 2px solid var(--light);
            border-radius: 10px;
            background: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: var(--text);
        }
        
        .user-type-btn:hover {
            border-color: var(--secondary);
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .user-type-btn.active {
            border-color: var(--secondary);
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
        }
        
        /* Mijoz sahifasi */
        .client-info {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light);
        }
        
        .client-id {
            display: inline-block;
            background-color: var(--primary);
            color: white;
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            border-radius: 10px;
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--light);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #666;
        }
        
        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: #d5f4e6;
            color: var(--success);
        }
        
        .badge-danger {
            background-color: #fadbd8;
            color: var(--danger);
        }
        
        .badge-warning {
            background-color: #fdebd0;
            color: var(--warning);
        }
        
        .badge-primary {
            background-color: #d6eaf8;
            color: var(--secondary);
        }
        
        /* Tema tugmasi - PASTDA */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background-color: var(--secondary);
            color: white;
            border: none;
            cursor: pointer;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--light);
            margin-bottom: 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-btn {
            padding: 10px 18px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 13px;
        }
        
        .tab-btn:hover {
            color: var(--secondary);
        }
        
        .tab-btn.active {
            color: var(--secondary);
            border-bottom: 3px solid var(--secondary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Bo'sh holat */
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 12px;
            color: #ddd;
        }
        
        /* Mijoz mahsulotlari ro'yxati */
        .client-products-list {
            margin-top: 20px;
        }
        
        .client-product-item {
            background-color: var(--light);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .client-product-info h4 {
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        /* To'lovlar ro'yxati */
        .payments-list {
            margin-top: 20px;
        }
        
        .payment-item {
            background-color: var(--light);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        /* Mobil uchun stillar */
        @media (max-width: 575px) {
            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .header-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .navbar {
                flex-direction: column;
            }
            
            .nav-btn {
                border-right: none;
                border-bottom: 1px solid var(--light);
                justify-content: flex-start;
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .user-type-btn {
                min-width: 100px;
                padding: 12px;
            }
            
            .btn {
                padding: 12px 20px;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .theme-toggle {
                bottom: 15px;
                left: 15px;
                width: 45px;
                height: 45px;
            }
            
            .modal-content {
                padding: 15px;
            }
            
            .client-product-item, .payment-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
        
        /* Tablet uchun */
        @media (min-width: 576px) and (max-width: 767px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .theme-toggle {
                bottom: 70px;
                left: 15px;
            }
        }
        
        /* Kompyuter uchun */
        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .btn {
                width: auto;
            }
            
            .theme-toggle {
                bottom: 20px;
                left: 20px;
            }
        }
        
        /* Inputlar uchun mobil klaviatura */
        input[type="number"],
        input[type="text"],
        input[type="date"],
        select,
        textarea {
            font-size: 16px !important;
        }
        
        /* Qo'shimcha */
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mb-3 {
            margin-bottom: 15px;
        }
        
        .mt-3 {
            margin-top: 15px;
        }
        
        /* Qarz to'lov modali */
        .debt-payment-modal {
            max-width: 400px;
        }
        
        .payment-amount-input {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
        }
        
        /* Mijoz qo'shish modal */
        .add-client-modal {
            max-width: 500px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
    </style>
</head>
<body>
    <!-- Kirish sahifasi -->
    <div id="loginPage" class="container login-container">
        <div class="login-card">
            <h2><i class="fas fa-tshirt"></i> Halat Savdosi Tizimi</h2>
            <p class="form-label">Siz kimsiz?</p>
            <div class="user-type-selector">
                <button id="clientBtn" class="user-type-btn active">
                    <i class="fas fa-user fa-2x"></i>
                    <span>Mijoz</span>
                </button>
                <button id="adminBtn" class="user-type-btn">
                    <i class="fas fa-user-shield fa-2x"></i>
                    <span>Sotuvchi</span>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label" id="idLabel">Mijoz ID raqamini kiriting (6 xonali)</label>
                <input type="text" id="userId" class="form-control" placeholder="Masalan: 482931" maxlength="6" inputmode="numeric">
            </div>
            
            <div id="loginError" class="alert alert-danger" style="display: none; background-color: #fadbd8; color: #e74c3c; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #e74c3c;">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorText">Noto'g'ri ID raqam!</span>
            </div>
            
            <button id="loginButton" class="btn btn-primary btn-block">
                <i class="fas fa-sign-in-alt"></i> Kirish
            </button>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border); color: #666; font-size: 12px;">
                <p><i class="fas fa-info-circle"></i> Mijoz ID raqami sizga halat sotilganda beriladi</p>
                <p><i class="fas fa-info-circle"></i> Sotuvchilar uchun parol NOMONOV tomonidan beriladi!</p>
            </div>
        </div>
    </div>
    
    <!-- Asosiy tizim sahifasi -->
    <div id="mainPage" class="container" style="display: none;">
        <!-- Sarlavha -->
        <div class="header">
            <h1><i class="fas fa-tshirt"></i> Halat Savdosi</h1>
            <div class="header-actions">
            
                <span id="currentUserType"></span>
                <button id="logoutBtn" class="btn btn-warning btn-sm">
                    <i class="fas fa-sign-out-alt"></i> Chiqish
                </button>
            </div>
        </div>
        
        <!-- Mijoz ma'lumotlari (faqat mijoz rejimida) -->
        <div id="clientInfoCard" class="card" style="display: none;">
            <div class="client-info">
                <div class="client-id">Mijoz ID: <span id="clientIdDisplay"></span></div>
                <h2 id="clientNameDisplay"></h2>
            </div>
            
            <!-- Mijoz statistikasi -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: var(--primary);">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="clientTotalDebt">0 so'm</h3>
                        <p>Jami qarz qoldig'i</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: var(--secondary);">
                        <i class="fas fa-tshirt"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="clientTotalProducts">0 dona</h3>
                        <p>Jami olingan mahsulot</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: var(--success);">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="clientTotalPaid">0 so'm</h3>
                        <p>Jami to'langan</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigatsiya (faqat admin rejimida) -->
        <div id="adminNav" class="navbar" style="display: none;">
            <button class="nav-btn active" data-page="dashboard">
                <i class="fas fa-tachometer-alt"></i> Boshqaruv
            </button>
            <button class="nav-btn" data-page="workshops">
                <i class="fas fa-industry"></i> Sexlar
            </button>
            <button class="nav-btn" data-page="storage">
                <i class="fas fa-warehouse"></i> Ombor
            </button>
            <button class="nav-btn" data-page="income">
                <i class="fas fa-arrow-right"></i> Kirim
            </button>
            <button class="nav-btn" data-page="sales">
                <i class="fas fa-shopping-cart"></i> Sotuv
            </button>
            <button class="nav-btn" data-page="returns">
                <i class="fas fa-exchange-alt"></i> Braklar
            </button>
            <button class="nav-btn" data-page="debts">
                <i class="fas fa-file-invoice-dollar"></i> Qarzlar
            </button>
        </div>
        
        <!-- Asosiy kontent -->
        <div id="pageContent">
            <!-- Mijoz sahifasi kontenti -->
            <div id="clientPage" class="page-content" style="display: none;">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-user"></i> Mening hisobim</h2>
                    
                    <div class="client-summary">
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: var(--primary); margin-bottom: 8px;">Mening ma'lumotlarim</h3>
                            <p><strong>Mijoz ID:</strong> <span id="clientIdDisplay2"></span></p>
                            <p><strong>Ism:</strong> <span id="clientNameDisplay2"></span></p>
                            <p><strong>Telefon:</strong> <span id="clientPhoneDisplay">-</span></p>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px;">
                            <div class="stat-card">
                                <div class="stat-icon" style="background-color: var(--secondary);">
                                    <i class="fas fa-tshirt"></i>
                                </div>
                                <div class="stat-info">
                                    <h3 id="clientTotalProducts2">0 dona</h3>
                                    <p>Jami olingan halatlar</p>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon" style="background-color: var(--success);">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div class="stat-info">
                                    <h3 id="clientTotalPaid2">0 so'm</h3>
                                    <p>Jami to'langan</p>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon" style="background-color: var(--danger);">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                </div>
                                <div class="stat-info">
                                    <h3 id="clientTotalDebt2">0 so'm</h3>
                                    <p>Jami qarzingiz</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mijozning mahsulotlari -->
                        <div class="client-products-list">
                            <h3 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-list"></i> Olingan mahsulotlar
                            </h3>
                            <div id="clientProductsList">
                                <!-- Mahsulotlar bu yerda ko'rsatiladi -->
                            </div>
                            <div id="clientProductsEmpty" class="empty-state" style="display: none;">
                                <i class="fas fa-tshirt"></i>
                                <h3>Hozircha mahsulotlar yo'q</h3>
                                <p>Siz hali mahsulot olmagansiz</p>
                            </div>
                        </div>
                        
                        <!-- To'lovlar tarixi -->
                        <div class="payments-list mt-3">
                            <h3 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-history"></i> To'lovlar tarixi
                            </h3>
                            <div id="clientPaymentsList">
                                <!-- To'lovlar bu yerda ko'rsatiladi -->
                            </div>
                            <div id="clientPaymentsEmpty" class="empty-state" style="display: none;">
                                <i class="fas fa-money-bill-wave"></i>
                                <h3>To'lovlar yo'q</h3>
                                <p>Hozircha to'lov amalga oshirilmagan</p>
                            </div>
                        </div>
                        
                        <div style="background-color: var(--light); padding: 15px; border-radius: 10px; margin-top: 20px;">
                            <h4 style="margin-bottom: 12px; color: var(--primary); font-size: 1.1rem;">
                                <i class="fas fa-info-circle"></i> Qarz to'lovlari haqida
                            </h4>
                            <p style="color: #666; line-height: 1.5; font-size: 13px;">
                                Qarz to'lovlarini faqat tizim administratori amalga oshira oladi. 
                                To'lov qilish uchun administrator bilan bog'laning.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Boshqaruv paneli (admin) -->
            <div id="dashboardPage" class="page-content">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-tachometer-alt"></i> Boshqaruv paneli</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background-color: var(--primary);">
                                <i class="fas fa-warehouse"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalProducts">0</h3>
                                <p>Ombor qoldig'i</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background-color: var(--success);">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalProfit">0 so'm</h3>
                                <p>Jami foyda</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background-color: var(--danger);">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalDebts">0 so'm</h3>
                                <p>Jami qarzlar</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background-color: var(--warning);">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalDefects">0</h3>
                                <p>Jami brak</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <h3 class="card-title"><i class="fas fa-chart-bar"></i> So'nggi harakatlar</h3>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Sana</th>
                                                <th>Turi</th>
                                                <th>Miqdori</th>
                                                <th>Summa</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentActivities">
                                            <!-- Faoliyatlar bu yerda ko'rsatiladi -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="activitiesEmpty" class="empty-state" style="display: none;">
                                    <i class="fas fa-history"></i>
                                    <h3>Hozircha harakatlar mavjud emas</h3>
                                    <p>Tizimda hali harakatlar amalga oshirilmagan</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div class="card">
                                <h3 class="card-title"><i class="fas fa-calendar-alt"></i> Bugungi hisobot</h3>
                                <div class="table-responsive">
                                    <table class="table">
                                        <tbody>
                                            <tr>
                                                <td><strong>Kirim:</strong></td>
                                                <td id="todayIncome">0 dona</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Sotuv:</strong></td>
                                                <td id="todaySales">0 dona</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Foyda:</strong></td>
                                                <td id="todayProfit">0 so'm</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Brak:</strong></td>
                                                <td id="todayDefects">0 dona</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sexlar -->
            <div id="workshopsPage" class="page-content" style="display: none;">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-industry"></i> Sexlar boshqaruvi</h2>
                    
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="addWorkshopTab">Yangi sex</button>
                        <button class="tab-btn" data-tab="workshopsListTab">Sexlar ro'yxati</button>
                    </div>
                    
                    <div id="addWorkshopTab" class="tab-content active">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-plus-circle"></i> Yangi sex qo'shish</h3>
                            <div class="form-group">
                                <label class="form-label">Sex nomi *</label>
                                <input type="text" id="workshopName" class="form-control" placeholder="Masalan: AKMAL AKA">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Telefon raqami</label>
                                <input type="tel" id="workshopPhone" class="form-control" placeholder="+998901234567" inputmode="tel">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Manzil</label>
                                <input type="text" id="workshopAddress" class="form-control" placeholder="Sex manzili">
                            </div>
                            <button id="addWorkshopBtn" class="btn btn-success">
                                <i class="fas fa-plus"></i> Sex qo'shish
                            </button>
                        </div>
                    </div>
                    
                    <div id="workshopsListTab" class="tab-content">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-list"></i> Mavjud sexlar</h3>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>â„–</th>
                                            <th>Sex nomi</th>
                                            <th>Telefon</th>
                                            <th>Qarz</th>
                                            <th>Harakatlar</th>
                                        </tr>
                                    </thead>
                                    <tbody id="workshopsList">
                                        <!-- Sexlar ro'yxati bu yerda ko'rsatiladi -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="workshopsEmpty" class="empty-state" style="display: none;">
                                <i class="fas fa-industry"></i>
                                <h3>Hozircha sexlar mavjud emas</h3>
                                <p>Yangi sex qo'shish uchun "Yangi sex" tabiga o'ting</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ombor -->
            <div id="storagePage" class="page-content" style="display: none;">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-warehouse"></i> Ombor hisobi</h2>
                    
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="storageSummary">Umumiy qoldiq</button>
                        <button class="tab-btn" data-tab="storageDetails">Batafsil hisobot</button>
                    </div>
                    
                    <div id="storageSummary" class="tab-content active">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Sex va Halat turi</th>
                                        <th>Kirim</th>
                                        <th>Sotuv</th>
                                        <th>Brak</th>
                                        <th>Sexga qaytarildi</th>
                                        <th>Qoldiq</th>
                                    </tr>
                                </thead>
                                <tbody id="storageSummaryBody">
                                    <!-- Ombor qoldiqlari bu yerda ko'rsatiladi -->
                                </tbody>
                            </table>
                        </div>
                        <div id="storageSummaryEmpty" class="empty-state" style="display: none;">
                            <i class="fas fa-warehouse"></i>
                            <h3>Ombor bo'sh</h3>
                            <p>Hozircha omborda mahsulot mavjud emas</p>
                        </div>
                    </div>
                    
                    <div id="storageDetails" class="tab-content">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-list"></i> Batafsil ombor hisobi</h3>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Sex</th>
                                            <th>Halat turi</th>
                                            <th>Jami kirim</th>
                                            <th>Jami sotuv</th>
                                            <th>Jami brak</th>
                                            <th>Sexga qaytarildi</th>
                                            <th>Hozirgi qoldiq</th>
                                            <th>O'rtacha narx</th>
                                        </tr>
                                    </thead>
                                    <tbody id="storageDetailsBody">
                                        <!-- Batafsil ombor hisobi bu yerda ko'rsatiladi -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Kirim (Sexdan) -->
            <div id="incomePage" class="page-content" style="display: none;">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-arrow-right"></i> Sexdan kirim qilish</h2>
                    
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="addIncomeTab">Yangi kirim</button>
                        <button class="tab-btn" data-tab="incomeHistoryTab">Kirim tarixi</button>
                    </div>
                    
                    <div id="addIncomeTab" class="tab-content active">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-plus-circle"></i> Yangi kirim</h3>
                            <div class="form-group">
                                <label class="form-label">Sana *</label>
                                <input type="date" id="incomeDate" class="form-control" value="">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sex *</label>
                                <select id="incomeWorkshop" class="form-control">
                                    <option value="">Sexni tanlang</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Halat turi *</label>
                                <input type="text" id="incomeProductType" class="form-control" placeholder="Masalan: Oddiy, Gilam, Baxmal">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Miqdori (dona) *</label>
                                <input type="number" id="incomeQuantity" class="form-control" placeholder="0" min="1" inputmode="numeric">
                            </div>
                            <div class="form-group">
                                <label class="form-label">1 dona kelish narxi (so'm) *</label>
                                <input type="number" id="incomePrice" class="form-control" placeholder="0" min="0" inputmode="numeric">
                            </div>
                            <div class="form-group">
                                <label class="form-label">To'langan summa (so'm)</label>
                                <input type="number" id="incomePaid" class="form-control" placeholder="0" min="0" inputmode="numeric">
                                <small style="color: #666;">Agar to'liq to'lanmagan bo'lsa, qarzga yoziladi</small>
                            </div>
                            <button id="addIncomeBtn" class="btn btn-success">
                                <i class="fas fa-check"></i> Kirimni saqlash
                            </button>
                        </div>
                    </div>
                    
                    <div id="incomeHistoryTab" class="tab-content">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-history"></i> Kirimlar tarixi</h3>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Sana</th>
                                            <th>Sex</th>
                                            <th>Halat turi</th>
                                            <th>Miqdori</th>
                                            <th>To'langan</th>
                                            <th>Qarz</th>
                                            <th>O'chirish</th>
                                        </tr>
                                    </thead>
                                    <tbody id="incomeHistory">
                                        <!-- Kirim tarixi bu yerda ko'rsatiladi -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="incomeHistoryEmpty" class="empty-state" style="display: none;">
                                <i class="fas fa-arrow-right"></i>
                                <h3>Kirimlar mavjud emas</h3>
                                <p>Hozircha sexdan kirim qilinmagan</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sotuv -->
            <div id="salesPage" class="page-content" style="display: none;">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-shopping-cart"></i> Mijozga sotish</h2>
                    
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="newSale">Yangi sotuv</button>
                        <button class="tab-btn" data-tab="salesHistory">Sotuv tarixi</button>
                        <button class="tab-btn" data-tab="clients">Mijozlar</button>
                    </div>
                    
                    <div id="newSale" class="tab-content active">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-cart-plus"></i> Sotuv ma'lumotlari</h3>
                            <div class="form-group">
                                <label class="form-label">Mijoz *</label>
                                <div class="input-group" style="display: flex; gap: 8px;">
                                    <select id="saleClient" class="form-control">
                                        <option value="">Mijozni tanlang</option>
                                    </select>
                                    <button id="newClientBtn" class="btn btn-primary" style="min-width: 50px; padding: 10px;">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sana *</label>
                                <input type="date" id="saleDate" class="form-control" value="">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Halat turi *</label>
                                <select id="saleProductType" class="form-control">
                                    <option value="">Halat turini tanlang</option>
                                </select>
                                <small style="color: #666;">Ombor qoldig'i: <span id="productStockInfo">0 dona</span></small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Miqdori (dona) *</label>
                                <input type="number" id="saleQuantity" class="form-control" placeholder="0" min="1" inputmode="numeric">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">1 dona sotish narxi (so'm) *</label>
                                <input type="number" id="salePrice" class="form-control" placeholder="0" min="0" inputmode="numeric">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">To'langan summa (so'm)</label>
                                <input type="number" id="salePaid" class="form-control" placeholder="0" min="0" inputmode="numeric">
                                <small style="color: #666;">Agar to'liq to'lanmagan bo'lsa, qarzga yoziladi</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Izoh</label>
                                <textarea id="saleNote" class="form-control" placeholder="Qo'shimcha izohlar..."></textarea>
                            </div>
                            
                            <div class="card" style="margin-top: 20px; background-color: var(--light);">
                                <h4 class="card-title"><i class="fas fa-calculator"></i> Sotuv hisoboti</h4>
                                <div style="padding: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span>Jami miqdor:</span>
                                        <strong id="saleTotalQuantity">0 dona</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span>Jami summa:</span>
                                        <strong id="saleTotalAmount">0 so'm</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span>To'langan:</span>
                                        <strong id="saleTotalPaid">0 so'm</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
                                        <span>Qarz qoldig'i:</span>
                                        <strong id="saleTotalDebt" style="color: var(--danger);">0 so'm</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid var(--border);">
                                        <span>Taxminiy foyda:</span>
                                        <strong id="saleEstimatedProfit" style="color: var(--success);">0 so'm</strong>
                                    </div>
                                </div>
                            </div>
                            
                            <button id="addSaleBtn" class="btn btn-success" style="margin-top: 20px;">
                                <i class="fas fa-check"></i> Sotuvni saqlash
                            </button>
                        </div>
                    </div>
                    
                    <div id="salesHistory" class="tab-content">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-history"></i> Sotuv tarixi</h3>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Sana</th>
                                            <th>Mijoz</th>
                                            <th>Halat turi</th>
                                            <th>Miqdori</th>
                                            <th>Jami summa</th>
                                            <th>To'langan</th>
                                            <th>Qarz</th>
                                            <th>O'chirish</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salesHistoryBody">
                                        <!-- Sotuv tarixi bu yerda ko'rsatiladi -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="salesHistoryEmpty" class="empty-state" style="display: none;">
                                <i class="fas fa-shopping-cart"></i>
                                <h3>Sotuvlar mavjud emas</h3>
                                <p>Hozircha mijozlarga sotuv amalga oshirilmagan</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="clients" class="tab-content">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-users"></i> Mijozlar boshqaruvi</h3>
                            
                            <div class="tabs">
                                <button class="tab-btn active" data-tab="addClientTab">Yangi mijoz</button>
                                <button class="tab-btn" data-tab="clientsListTab">Mijozlar ro'yxati</button>
                            </div>
                            
                            <!-- Yangi mijoz qo'shish -->
                            <div id="addClientTab" class="tab-content active">
                                <div class="card">
                                    <h4 class="card-title"><i class="fas fa-user-plus"></i> Yangi mijoz qo'shish</h4>
                                    <div class="form-group">
                                        <label class="form-label">Mijoz nomi *</label>
                                        <input type="text" id="newClientName" class="form-control" placeholder="To'liq ism">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Telefon raqami</label>
                                        <input type="tel" id="newClientPhone" class="form-control" placeholder="+998901234567" inputmode="tel">
                                    </div>
                                    <button id="saveNewClientBtn" class="btn btn-success">
                                        <i class="fas fa-save"></i> Mijozni saqlash
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Mijozlar ro'yxati -->
                            <div id="clientsListTab" class="tab-content">
                                <div class="card">
                                    <h4 class="card-title"><i class="fas fa-list"></i> Mijozlar ro'yxati</h4>
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Ism</th>
                                                    <th>Telefon</th>
                                                    <th>Jami olgan (so'm)</th>
                                                    <th>Jami to'lagan (so'm)</th>
                                                    <th>Jami brak chegirmasi</th>
                                                    <th>Qarz qoldig'i</th>
                                                    <th>Harakatlar</th>
                                                </tr>
                                            </thead>
                                            <tbody id="clientsListTable">
                                                <!-- Mijozlar ro'yxati bu yerda ko'rsatiladi -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div id="clientsListEmpty" class="empty-state" style="display: none;">
                                        <i class="fas fa-users"></i>
                                        <h3>Mijozlar mavjud emas</h3>
                                        <p>Yangi mijoz qo'shish uchun "Yangi mijoz" tabiga o'ting</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Braklar -->
            <div id="returnsPage" class="page-content" style="display: none;">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-exchange-alt"></i> Braklar boshqaruvi</h2>
                    
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="defectProduct">Brak qaydnomasi</button>
                        <button class="tab-btn" data-tab="returnToWorkshop">Sexga qaytarish</button>
                        <button class="tab-btn" data-tab="returnsHistory">Brak tarixi</button>
                    </div>
                    
                    <div id="defectProduct" class="tab-content active">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> Mijozdan brak olib kelish</h3>
                            <div class="form-group">
                                <label class="form-label">Mijoz *</label>
                                <select id="defectClient" class="form-control">
                                    <option value="">Mijozni tanlang</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sex *</label>
                                <select id="defectWorkshop" class="form-control">
                                    <option value="">Sexni tanlang</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Halat turi *</label>
                                <input type="text" id="defectProductType" class="form-control" placeholder="Masalan: Oddiy, Gilam, Baxmal">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Brak miqdori (dona) *</label>
                                <input type="number" id="defectQuantity" class="form-control" placeholder="0" min="1" inputmode="numeric">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Brak sababi *</label>
                                <select id="defectReason" class="form-control">
                                    <option value="">Sababni tanlang</option>
                                    <option value="tugun">Tugun</option>
                                    <option value="chandiq">Chandiq</option>
                                    <option value="tish">Tish</option>
                                    <option value="rang noto'g'ri">Rang noto'g'ri</option>
                                    <option value="boshqa">Boshqa sabab</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Izoh</label>
                                <textarea id="defectNote" class="form-control" placeholder="Brak haqida qo'shimcha ma'lumot..."></textarea>
                            </div>
                            <button id="processDefectBtn" class="btn btn-warning">
                                <i class="fas fa-exclamation-triangle"></i> Brakni ro'yxatga olish
                            </button>
                        </div>
                    </div>
                    
                    <div id="returnToWorkshop" class="tab-content">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-undo"></i> Brak mahsulotni sexga qaytarish</h3>
                            <div class="form-group">
                                <label class="form-label">Sex *</label>
                                <select id="returnToWorkshopSelect" class="form-control">
                                    <option value="">Sexni tanlang</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Halat turi *</label>
                                <select id="returnToWorkshopProduct" class="form-control">
                                    <option value="">Halat turini tanlang</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Qaytarish miqdori (dona) *</label>
                                <input type="number" id="returnToWorkshopQuantity" class="form-control" placeholder="0" min="1" inputmode="numeric">
                                <small style="color: #666;">Maksimal: <span id="maxReturnToWorkshopQuantity">0 dona</span></small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sabab</label>
                                <textarea id="returnToWorkshopNote" class="form-control" placeholder="Qaytarish sababi..."></textarea>
                            </div>
                            <button id="processReturnToWorkshopBtn" class="btn btn-danger">
                                <i class="fas fa-undo"></i> Sexga qaytarish
                            </button>
                        </div>
                    </div>
                    
                    <div id="returnsHistory" class="tab-content">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-history"></i> Braklar tarixi</h3>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Sana</th>
                                            <th>Turi</th>
                                            <th>Mijoz/Sex</th>
                                            <th>Halat turi</th>
                                            <th>Miqdori</th>
                                            <th>Sabab</th>
                                            <th>O'chirish</th>
                                        </tr>
                                    </thead>
                                    <tbody id="returnsHistoryBody">
                                        <!-- Brak tarixi bu yerda ko'rsatiladi -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="returnsHistoryEmpty" class="empty-state" style="display: none;">
                                <i class="fas fa-exchange-alt"></i>
                                <h3>Brak qaydnomalari mavjud emas</h3>
                                <p>Hozircha brak mahsulotlar mavjud emas</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Qarzlar -->
            <div id="debtsPage" class="page-content" style="display: none;">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-file-invoice-dollar"></i> Qarzlar hisobi</h2>
                    
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="workshopDebts">Sexlar qarzi</button>
                        <button class="tab-btn" data-tab="clientDebts">Mijozlar qarzi</button>
                        <button class="tab-btn" data-tab="debtPayments">Qarz to'lovlari</button>
                    </div>
                    
                    <div id="workshopDebts" class="tab-content active">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-industry"></i> Sexlar qarzi</h3>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Sex nomi</th>
                                            <th>Jami olingan</th>
                                            <th>Jami to'langan</th>
                                            <th>Brak chegirmalari</th>
                                            <th>Qarz qoldig'i</th>
                                            <th>To'lash</th>
                                        </tr>
                                    </thead>
                                    <tbody id="workshopDebtsBody">
                                        <!-- Sexlar qarzlari bu yerda ko'rsatiladi -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="workshopDebtsEmpty" class="empty-state" style="display: none;">
                                <i class="fas fa-industry"></i>
                                <h3>Sexlar qarzi mavjud emas</h3>
                                <p>Hozircha sexlarning qarzlari mavjud emas</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="clientDebts" class="tab-content">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-users"></i> Mijozlar qarzi</h3>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Mijoz</th>
                                            <th>Jami olgan</th>
                                            <th>Jami to'lagan</th>
                                            <th>Brak kamaytmasi</th>
                                            <th>Qarz qoldig'i</th>
                                            <th>To'lash</th>
                                        </tr>
                                    </thead>
                                    <tbody id="clientDebtsBody">
                                        <!-- Mijozlar qarzlari bu yerda ko'rsatiladi -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="clientDebtsEmpty" class="empty-state" style="display: none;">
                                <i class="fas fa-users"></i>
                                <h3>Mijozlar qarzi mavjud emas</h3>
                                <p>Hozircha mijozlarning qarzlari mavjud emas</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="debtPayments" class="tab-content">
                        <div class="tabs">
                            <button class="tab-btn active" data-tab="addPaymentTab">To'lov qilish</button>
                            <button class="tab-btn" data-tab="paymentsHistoryTab">To'lovlar tarixi</button>
                        </div>
                        
                        <div id="addPaymentTab" class="tab-content active">
                            <div class="card">
                                <h3 class="card-title"><i class="fas fa-money-bill-wave"></i> Qarz to'lash</h3>
                                <div class="form-group">
                                    <label class="form-label">To'lov turi *</label>
                                    <select id="paymentType" class="form-control">
                                        <option value="">To'lov turini tanlang</option>
                                        <option value="workshop">Sexga to'lov</option>
                                        <option value="client">Mijozdan to'lov</option>
                                    </select>
                                </div>
                                <div class="form-group" id="paymentWorkshopGroup" style="display: none;">
                                    <label class="form-label">Sex *</label>
                                    <select id="paymentWorkshop" class="form-control">
                                        <option value="">Sexni tanlang</option>
                                    </select>
                                </div>
                                <div class="form-group" id="paymentClientGroup" style="display: none;">
                                    <label class="form-label">Mijoz *</label>
                                    <select id="paymentClient" class="form-control">
                                        <option value="">Mijozni tanlang</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">To'lov summasi (so'm) *</label>
                                    <input type="number" id="paymentAmount" class="form-control payment-amount-input" placeholder="0" min="1" inputmode="numeric">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">To'lov sanasi *</label>
                                    <input type="date" id="paymentDate" class="form-control" value="">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Izoh</label>
                                    <input type="text" id="paymentNote" class="form-control" placeholder="To'lov haqida izoh">
                                </div>
                                <button id="processPaymentBtn" class="btn btn-success">
                                    <i class="fas fa-check"></i> To'lovni saqlash
                                </button>
                            </div>
                        </div>
                        
                        <div id="paymentsHistoryTab" class="tab-content">
                            <div class="card">
                                <h3 class="card-title"><i class="fas fa-history"></i> To'lovlar tarixi</h3>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Sana</th>
                                                <th>Kimdan/Kimga</th>
                                                <th>Summa</th>
                                                <th>Izoh</th>
                                            </tr>
                                    </thead>
                                        <tbody id="paymentsHistory">
                                            <!-- To'lovlar tarixi bu yerda ko'rsatiladi -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="paymentsHistoryEmpty" class="empty-state" style="display: none;">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <h3>To'lovlar mavjud emas</h3>
                                    <p>Hozircha qarz to'lovlari amalga oshirilmagan</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal oynalar -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="messageModalTitle">Xabar</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="messageModalBody" style="padding: 20px 0;">
                <!-- Xabar matni bu yerda ko'rsatiladi -->
            </div>
            <div style="text-align: right; padding-top: 20px; border-top: 1px solid var(--light);">
                <button id="closeMessageModal" class="btn btn-primary">Yopish</button>
            </div>
        </div>
    </div>

    <!-- Qarz to'lov modali -->
    <div id="debtPaymentModal" class="modal">
        <div class="modal-content debt-payment-modal">
            <div class="modal-header">
                <h3 id="debtPaymentModalTitle">Qarz to'lash</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div style="padding: 20px 0;">
                <div class="form-group">
                    <label class="form-label">Joriy qarz:</label>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--danger); text-align: center; padding: 10px; background-color: var(--light); border-radius: 8px;">
                        <span id="currentDebtAmount">0 so'm</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">To'lov summasi (so'm) *</label>
                    <input type="number" id="debtPaymentAmount" class="form-control payment-amount-input" placeholder="0" min="1" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label class="form-label">To'lov sanasi *</label>
                    <input type="date" id="debtPaymentDate" class="form-control" value="">
                </div>
                <div class="form-group">
                    <label class="form-label">Izoh</label>
                    <input type="text" id="debtPaymentNote" class="form-control" placeholder="To'lov haqida izoh">
                </div>
                <input type="hidden" id="debtPaymentType">
                <input type="hidden" id="debtPaymentId">
            </div>
            <div style="text-align: right; padding-top: 20px; border-top: 1px solid var(--light);">
                <button id="cancelDebtPayment" class="btn btn-warning" style="margin-right: 10px;">Bekor qilish</button>
                <button id="confirmDebtPayment" class="btn btn-success">To'lash</button>
            </div>
        </div>
    </div>

    <!-- Mijoz qo'shish modali -->
    <div id="addClientModal" class="modal">
        <div class="modal-content add-client-modal">
            <div class="modal-header">
                <h3>Yangi mijoz qo'shish</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div style="padding: 20px 0;">
                <div class="form-group">
                    <label class="form-label">Mijoz nomi *</label>
                    <input type="text" id="modalClientName" class="form-control" placeholder="To'liq ism">
                </div>
                <div class="form-group">
                    <label class="form-label">Telefon raqami</label>
                    <input type="tel" id="modalClientPhone" class="form-control" placeholder="+998901234567" inputmode="tel">
                </div>
            </div>
            <div style="text-align: right; padding-top: 20px; border-top: 1px solid var(--light);">
                <button id="cancelAddClient" class="btn btn-warning" style="margin-right: 10px;">Bekor qilish</button>
                <button id="saveModalClientBtn" class="btn btn-success">Saqlash</button>
            </div>
        </div>
    </div>

    <!-- Tema tugmasi - PASTDA -->
    <button id="themeToggle" class="theme-toggle">
        <i class="fas fa-moon"></i>
    </button>

    <!-- JavaScript -->
    <script>
        // Asosiy o'zgaruvchilar
        let currentUser = null;
        let currentUserType = null;
        let currentPage = 'dashboard';
        let currentTheme = 'light';
        
        // Firebase ma'lumotlari - obyekt shaklida saqlash uchun
        let appData = {
            workshops: [],
            clients: [],
            storage: [],
            incomes: [],
            sales: [],
            defects: [],
            workshopReturns: [],
            payments: [],
            activities: [],
            app_initialized: false
        };
        
        // Dastur ma'lumotlarini yaratish
        const initializeData = async function() {
            try {
                const initialized = await DB.load('app_initialized');
                
                if (!initialized) {
                    console.log('Dastur birinchi marta ishga tushirildi, Firebase\'ga test ma\'lumotlari yaratilmoqda...');
                    
                    // Test ma'lumotlari
                    appData.workshops = [
                        {
                            id: 1,
                            name: "AKMAL AKA",
                            phone: "+998901112233",
                            address: "Chorsu bozori",
                            debt: 250000,
                            total_purchased: 1000000,
                            total_paid: 750000,
                            defect_deductions: 0,
                            avg_price: 50000
                        },
                        {
                            id: 2,
                            name: "SHERZOD",
                            phone: "+998902223344",
                            address: "Yunusobod",
                            debt: 180000,
                            total_purchased: 800000,
                            total_paid: 620000,
                            defect_deductions: 0,
                            avg_price: 45000
                        }
                    ];
                    
                    appData.clients = [
                        {
                            id: 123456,
                            name: "Ali Valiyev",
                            phone: "+998901234567",
                            created: new Date().toISOString(),
                            total_purchased: 1500000,
                            total_purchased_quantity: 15,
                            total_paid: 1000000,
                            defect_deductions: 50000,
                            debt: 450000
                        },
                        {
                            id: 234567,
                            name: "Hasan Hasanov",
                            phone: "+998902345678",
                            created: new Date().toISOString(),
                            total_purchased: 800000,
                            total_purchased_quantity: 8,
                            total_paid: 600000,
                            defect_deductions: 20000,
                            debt: 180000
                        },
                        {
                            id: 345678,
                            name: "Botir Qodirov",
                            phone: "+998903456789",
                            created: new Date().toISOString(),
                            total_purchased: 1200000,
                            total_purchased_quantity: 12,
                            total_paid: 1200000,
                            defect_deductions: 0,
                            debt: 0
                        }
                    ];
                    
                    appData.storage = [];
                    appData.incomes = [];
                    appData.sales = [];
                    appData.defects = [];
                    appData.workshopReturns = [];
                    appData.payments = [];
                    appData.activities = [];
                    appData.app_initialized = true;
                    
                    // Barcha ma'lumotlarni Firebase'ga saqlash
                    await Promise.all([
                        DB.save('workshops', appData.workshops),
                        DB.save('clients', appData.clients),
                        DB.save('storage', appData.storage),
                        DB.save('incomes', appData.incomes),
                        DB.save('sales', appData.sales),
                        DB.save('defects', appData.defects),
                        DB.save('workshopReturns', appData.workshopReturns),
                        DB.save('payments', appData.payments),
                        DB.save('activities', appData.activities),
                        DB.save('app_initialized', appData.app_initialized)
                    ]);
                    
                    console.log('Test ma\'lumotlar Firebase\'ga yaratildi.');
                } else {
                    // Firebase'dan ma'lumotlarni yuklash
                    console.log('Firebase\'dan ma\'lumotlar yuklanmoqda...');
                    appData.workshops = await DB.load('workshops') || [];
                    appData.clients = await DB.load('clients') || [];
                    appData.storage = await DB.load('storage') || [];
                    appData.incomes = await DB.load('incomes') || [];
                    appData.sales = await DB.load('sales') || [];
                    appData.defects = await DB.load('defects') || [];
                    appData.workshopReturns = await DB.load('workshopReturns') || [];
                    appData.payments = await DB.load('payments') || [];
                    appData.activities = await DB.load('activities') || [];
                    
                    console.log('Firebase\'dan ma\'lumotlar muvaffaqiyatli yuklandi');
                }
                
                // Ma'lumotlar o'zgarishini kuzatish
                DB.onDataChange('workshops', (data) => {
                    if (data) {
                        appData.workshops = Object.values(data);
                        if (currentPage === 'workshops' || currentPage === 'dashboard' || currentPage === 'debts') {
                            updatePage(currentPage);
                        }
                    }
                });
                
                DB.onDataChange('clients', (data) => {
                    if (data) {
                        appData.clients = Object.values(data);
                        if (currentPage === 'sales' || currentPage === 'debts' || currentPage === 'client') {
                            updatePage(currentPage);
                        }
                    }
                });
                
                DB.onDataChange('incomes', (data) => {
                    if (data) {
                        appData.incomes = Object.values(data);
                        if (currentPage === 'income' || currentPage === 'dashboard') {
                            updatePage(currentPage);
                        }
                    }
                });
                
                DB.onDataChange('sales', (data) => {
                    if (data) {
                        appData.sales = Object.values(data);
                        if (currentPage === 'sales' || currentPage === 'dashboard') {
                            updatePage(currentPage);
                        }
                    }
                });
                
                DB.onDataChange('activities', (data) => {
                    if (data) {
                        appData.activities = Object.values(data);
                        if (currentPage === 'dashboard') {
                            updateRecentActivities();
                        }
                    }
                });
                
            } catch (error) {
                console.error('Ma\'lumotlarni yuklashda xatolik:', error);
                showMessage('Ma\'lumotlar bazasiga ulanishda xatolik!', 'error');
            }
        };
        
        // Tasodifiy mijoz ID yaratish
        const generateClientId = function() {
            let id;
            const existingIds = appData.clients.map(c => c.id);
            
            do {
                id = Math.floor(100000 + Math.random() * 900000);
            } while (existingIds.includes(id));
            
            return id;
        };
        
        // Formatlash funksiyalari
        const formatDate = function(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('uz-UZ', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        };
        
        const formatNumber = function(num) {
            if (!num && num !== 0) return '0';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        };
        
        // Modal oynani ko'rsatish
        const showModal = function(title, message, isError = false) {
            document.getElementById('messageModalTitle').textContent = title;
            document.getElementById('messageModalBody').innerHTML = `<p>${message}</p>`;
            document.getElementById('messageModal').style.display = 'flex';
            
            if (isError) {
                document.getElementById('messageModalTitle').style.color = 'var(--danger)';
            } else {
                document.getElementById('messageModalTitle').style.color = 'var(--primary)';
            }
        };
        
        const showMessage = function(message, type = 'success') {
            showModal(type === 'error' ? 'Xatolik' : 'Muvaffaqiyat', message, type === 'error');
        };
        
        // Aktivlik qo'shish
        const addActivity = async function(type, details) {
            try {
                let activities = [...appData.activities];
                
                activities.unshift({
                    id: Date.now(),
                    type: type,
                    details: details,
                    timestamp: new Date().toISOString(),
                    user: currentUserType === 'admin' ? 'Admin' : (currentUser ? currentUser.name : 'Noma\'lum')
                });
                
                if (activities.length > 50) {
                    activities.length = 50;
                }
                
                await DB.save('activities', activities);
                appData.activities = activities;
                updateRecentActivities();
            } catch (error) {
                console.error('Aktivlik qo\'shishda xatolik:', error);
            }
        };
        
        // Bo'sh holatni tekshirish
        const checkEmptyState = function(elementId, dataArray) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (dataArray.length === 0) {
                element.style.display = 'block';
            } else {
                element.style.display = 'none';
            }
        };
        
        // Sahifani yangilash
        const updatePage = function(pageId) {
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });
            
            const pageElement = document.getElementById(pageId + 'Page');
            if (pageElement) {
                pageElement.style.display = 'block';
            }
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const navBtn = document.querySelector(`.nav-btn[data-page="${pageId}"]`);
            if (navBtn) {
                navBtn.classList.add('active');
            }
            
            currentPage = pageId;
            
            switch(pageId) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'workshops':
                    updateWorkshops();
                    break;
                case 'storage':
                    updateStorage();
                    break;
                case 'income':
                    updateIncomePage();
                    break;
                case 'sales':
                    updateSalesPage();
                    break;
                case 'returns':
                    updateReturnsPage();
                    break;
                case 'debts':
                    updateDebtsPage();
                    break;
                case 'client':
                    updateClientPage();
                    break;
            }
            
            window.scrollTo(0, 0);
        };
        
        // Boshqaruv panelini yangilash
        const updateDashboard = function() {
            const storage = appData.storage;
            const sales = appData.sales;
            const incomes = appData.incomes;
            const defects = appData.defects;
            const workshops = appData.workshops;
            const clients = appData.clients;
            
            // Ombor qoldig'i
            let totalProducts = 0;
            storage.forEach(item => {
                totalProducts += item.current_balance || 0;
            });
            document.getElementById('totalProducts').textContent = formatNumber(totalProducts);
            
            // Jami foyda
            let totalProfit = 0;
            sales.forEach(sale => {
                const storageItem = storage.find(item => item.key === sale.storage_key);
                const avgCost = storageItem ? storageItem.avg_price : 0;
                const salePrice = sale.price_per_unit || 0;
                const quantity = sale.quantity || 0;
                
                totalProfit += (salePrice - avgCost) * quantity;
            });
            document.getElementById('totalProfit').textContent = formatNumber(Math.round(totalProfit)) + ' so\'m';
            
            // Jami qarzlar
            let totalDebts = 0;
            workshops.forEach(workshop => {
                totalDebts += workshop.debt || 0;
            });
            clients.forEach(client => {
                totalDebts += client.debt || 0;
            });
            document.getElementById('totalDebts').textContent = formatNumber(Math.round(totalDebts)) + ' so\'m';
            
            // Jami brak
            let totalDefects = 0;
            defects.forEach(defect => {
                totalDefects += defect.quantity || 0;
            });
            document.getElementById('totalDefects').textContent = formatNumber(totalDefects);
            
            // Bugungi hisobot
            const today = new Date().toISOString().split('T')[0];
            
            let todayIncome = 0;
            incomes.filter(income => income.date === today).forEach(income => {
                todayIncome += income.quantity || 0;
            });
            document.getElementById('todayIncome').textContent = formatNumber(todayIncome) + ' dona';
            
            let todaySales = 0;
            sales.filter(sale => sale.date === today).forEach(sale => {
                todaySales += sale.quantity || 0;
            });
            document.getElementById('todaySales').textContent = formatNumber(todaySales) + ' dona';
            
            let todayProfit = 0;
            sales.filter(sale => sale.date === today).forEach(sale => {
                const storageItem = storage.find(item => item.key === sale.storage_key);
                const avgCost = storageItem ? storageItem.avg_price : 0;
                const salePrice = sale.price_per_unit || 0;
                const quantity = sale.quantity || 0;
                
                todayProfit += (salePrice - avgCost) * quantity;
            });
            document.getElementById('todayProfit').textContent = formatNumber(Math.round(todayProfit)) + ' so`m';
            
            let todayDefects = 0;
            defects.filter(defect => defect.date === today).forEach(defect => {
                todayDefects += defect.quantity || 0;
            });
            document.getElementById('todayDefects').textContent = formatNumber(todayDefects) + ' dona';
            
            updateRecentActivities();
        };
        
        // So'nggi aktivliklarni yangilash
        const updateRecentActivities = function() {
            const activities = appData.activities;
            const tbody = document.getElementById('recentActivities');
            
            if (!tbody) return;
            
            tbody.innerHTML = '';
            checkEmptyState('activitiesEmpty', activities);
            
            const recentActivities = activities.slice(0, 5);
            
            recentActivities.forEach(activity => {
                const row = document.createElement('tr');
                
                let typeText = '';
                let icon = '';
                
                switch(activity.type) {
                    case 'income':
                        typeText = 'Kirim';
                        icon = '<i class="fas fa-arrow-right text-primary"></i>';
                        break;
                    case 'sale':
                        typeText = 'Sotuv';
                        icon = '<i class="fas fa-shopping-cart text-success"></i>';
                        break;
                    case 'defect':
                        typeText = 'Brak';
                        icon = '<i class="fas fa-exclamation-triangle text-warning"></i>';
                        break;
                    case 'workshop_return':
                        typeText = 'Sexga qaytarish';
                        icon = '<i class="fas fa-undo text-danger"></i>';
                        break;
                    case 'payment':
                        typeText = 'To\'lov';
                        icon = '<i class="fas fa-money-bill-wave text-success"></i>';
                        break;
                    default:
                        typeText = 'Boshqa';
                        icon = '<i class="fas fa-info-circle text-secondary"></i>';
                }
                
                row.innerHTML = `
                    <td>${formatDate(activity.timestamp)}</td>
                    <td>${icon} ${typeText}</td>
                    <td>${activity.details.substring(0, 30)}${activity.details.length > 30 ? '...' : ''}</td>
                    <td>${activity.user}</td>
                `;
                
                tbody.appendChild(row);
            });
        };
        
        // Sexlar sahifasini yangilash
        const updateWorkshops = function() {
            const workshops = appData.workshops;
            const tbody = document.getElementById('workshopsList');
            
            if (!tbody) return;
            
            tbody.innerHTML = '';
            checkEmptyState('workshopsEmpty', workshops);
            
            workshops.forEach((workshop, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${workshop.name}</td>
                    <td>${workshop.phone || ''}</td>
                    <td>${formatNumber(Math.round(workshop.debt || 0))} so'm</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editWorkshop(${workshop.id})" style="padding: 6px 12px; margin: 2px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteWorkshop(${workshop.id})" style="padding: 6px 12px; margin: 2px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            updateWorkshopsSelectOptions();
        };
        
        // Sexlar ro'yxatini select elementlariga qo'shish
        const updateWorkshopsSelectOptions = function() {
            const workshops = appData.workshops;
            
            const incomeWorkshopSelect = document.getElementById('incomeWorkshop');
            if (incomeWorkshopSelect) {
                incomeWorkshopSelect.innerHTML = '<option value="">Sexni tanlang</option>';
                workshops.forEach(workshop => {
                    const option = document.createElement('option');
                    option.value = workshop.id;
                    option.textContent = workshop.name;
                    incomeWorkshopSelect.appendChild(option);
                });
            }
            
            const defectWorkshopSelect = document.getElementById('defectWorkshop');
            if (defectWorkshopSelect) {
                defectWorkshopSelect.innerHTML = '<option value="">Sexni tanlang</option>';
                workshops.forEach(workshop => {
                    const option = document.createElement('option');
                    option.value = workshop.id;
                    option.textContent = workshop.name;
                    defectWorkshopSelect.appendChild(option);
                });
            }
            
            const returnToWorkshopSelect = document.getElementById('returnToWorkshopSelect');
            if (returnToWorkshopSelect) {
                returnToWorkshopSelect.innerHTML = '<option value="">Sexni tanlang</option>';
                workshops.forEach(workshop => {
                    const option = document.createElement('option');
                    option.value = workshop.id;
                    option.textContent = workshop.name;
                    returnToWorkshopSelect.appendChild(option);
                });
            }
            
            const paymentWorkshopSelect = document.getElementById('paymentWorkshop');
            if (paymentWorkshopSelect) {
                paymentWorkshopSelect.innerHTML = '<option value="">Sexni tanlang</option>';
                workshops.forEach(workshop => {
                    const option = document.createElement('option');
                    option.value = workshop.id;
                    option.textContent = workshop.name;
                    paymentWorkshopSelect.appendChild(option);
                });
            }
        };
        
        // Ombor sahifasini yangilash
        const updateStorage = function() {
            const storage = appData.storage;
            const summaryBody = document.getElementById('storageSummaryBody');
            
            if (summaryBody) {
                summaryBody.innerHTML = '';
                checkEmptyState('storageSummaryEmpty', storage);
                
                storage.forEach(item => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${item.workshop_name} - ${item.product_type}</td>
                        <td>${formatNumber(item.total_in || 0)} dona</td>
                        <td>${formatNumber(item.total_out || 0)} dona</td>
                        <td>${formatNumber(item.defects || 0)} dona</td>
                        <td>${formatNumber(item.workshop_returns || 0)} dona</td>
                        <td>${formatNumber(item.current_balance || 0)} dona</td>
                    `;
                    
                    summaryBody.appendChild(row);
                });
            }
            
            // Batafsil ombor hisobi
            const detailsBody = document.getElementById('storageDetailsBody');
            if (detailsBody) {
                detailsBody.innerHTML = '';
                
                storage.forEach(item => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${item.workshop_name}</td>
                        <td>${item.product_type}</td>
                        <td>${formatNumber(item.total_in || 0)} dona</td>
                        <td>${formatNumber(item.total_out || 0)} dona</td>
                        <td>${formatNumber(item.defects || 0)} dona</td>
                        <td>${formatNumber(item.workshop_returns || 0)} dona</td>
                        <td>${formatNumber(item.current_balance || 0)} dona</td>
                        <td>${formatNumber(Math.round(item.avg_price || 0))} so'm</td>
                    `;
                    
                    detailsBody.appendChild(row);
                });
            }
            
            updateProductTypesForSales();
            updateWorkshopProductsForReturns();
        };
        
        // Sotuv sahifasi uchun mahsulot turlarini yangilash
        const updateProductTypesForSales = function() {
            const storage = appData.storage;
            const productSelect = document.getElementById('saleProductType');
            
            if (!productSelect) return;
            
            productSelect.innerHTML = '<option value="">Halat turini tanlang</option>';
            
            storage.forEach(item => {
                if (item.current_balance > 0) {
                    const option = document.createElement('option');
                    option.value = item.key;
                    option.textContent = `${item.workshop_name} - ${item.product_type} (qoldiq: ${item.current_balance} dona)`;
                    option.setAttribute('data-workshop-id', item.workshop_id);
                    option.setAttribute('data-workshop-name', item.workshop_name);
                    option.setAttribute('data-product-type', item.product_type);
                    productSelect.appendChild(option);
                }
            });
        };
        
        // Sexga qaytarish uchun mahsulot turlarini yangilash
        const updateWorkshopProductsForReturns = function() {
            const storage = appData.storage;
            const productSelect = document.getElementById('returnToWorkshopProduct');
            
            if (!productSelect) return;
            
            productSelect.innerHTML = '<option value="">Halat turini tanlang</option>';
            
            storage.forEach(item => {
                if (item.defects > 0) {
                    const option = document.createElement('option');
                    option.value = item.key;
                    option.textContent = `${item.workshop_name} - ${item.product_type} (brak: ${item.defects} dona)`;
                    option.setAttribute('data-workshop-id', item.workshop_id);
                    option.setAttribute('data-workshop-name', item.workshop_name);
                    option.setAttribute('data-product-type', item.product_type);
                    productSelect.appendChild(option);
                }
            });
        };
        
        // Kirim sahifasini yangilash
        const updateIncomePage = function() {
            const today = new Date().toISOString().split('T')[0];
            const incomeDate = document.getElementById('incomeDate');
            if (incomeDate && !incomeDate.value) {
                incomeDate.value = today;
            }
            
            const incomes = appData.incomes;
            const tbody = document.getElementById('incomeHistory');
            
            if (tbody) {
                tbody.innerHTML = '';
                checkEmptyState('incomeHistoryEmpty', incomes);
                
                const recentIncomes = incomes.slice(-10).reverse();
                
                recentIncomes.forEach(income => {
                    const row = document.createElement('tr');
                    
                    const workshops = appData.workshops;
                    const workshop = workshops.find(w => w.id == income.workshop_id);
                    const workshopName = workshop ? workshop.name : 'Noma\'lum';
                    
                    const totalAmount = (income.price_per_unit || 0) * (income.quantity || 0);
                    const paid = income.paid || 0;
                    const debt = totalAmount - paid;
                    
                    row.innerHTML = `
                        <td>${formatDate(income.date)}</td>
                        <td>${workshopName}</td>
                        <td>${income.product_type}</td>
                        <td>${formatNumber(income.quantity)} dona</td>
                        <td>${formatNumber(Math.round(paid))} so'm</td>
                        <td>${debt > 0 ? '<span class="badge badge-danger">' + formatNumber(Math.round(debt)) + ' so\'m</span>' : '<span class="badge badge-success">To\'langan</span>'}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteIncome(${income.id})" style="padding: 6px 12px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
        };
        
        // Sotuv sahifasini yangilash
        const updateSalesPage = function() {
            const clients = appData.clients;
            const clientSelect = document.getElementById('saleClient');
            
            if (clientSelect) {
                clientSelect.innerHTML = '<option value="">Mijozni tanlang</option>';
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.name}${client.phone ? ' (' + client.phone + ')' : ''}`;
                    clientSelect.appendChild(option);
                });
            }
            
            const defectClientSelect = document.getElementById('defectClient');
            if (defectClientSelect) {
                defectClientSelect.innerHTML = '<option value="">Mijozni tanlang</option>';
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.name}${client.phone ? ' (' + client.phone + ')' : ''}`;
                    defectClientSelect.appendChild(option);
                });
            }
            
            const today = new Date().toISOString().split('T')[0];
            const saleDate = document.getElementById('saleDate');
            if (saleDate && !saleDate.value) {
                saleDate.value = today;
            }
            
            updateClientsTab();
            updateSalesHistory();
        };
        
        // Mijozlar tab'ini yangilash
        const updateClientsTab = function() {
            const clients = appData.clients;
            const tbody = document.getElementById('clientsListTable');
            
            if (!tbody) return;
            
            tbody.innerHTML = '';
            checkEmptyState('clientsListEmpty', clients);
            
            clients.forEach(client => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td><strong>${client.id}</strong></td>
                    <td>${client.name}</td>
                    <td>${client.phone || ''}</td>
                    <td>${formatNumber(Math.round(client.total_purchased || 0))} so'm</td>
                    <td>${formatNumber(Math.round(client.total_paid || 0))} so'm</td>
                    <td>${formatNumber(Math.round(client.defect_deductions || 0))} so'm</td>
                    <td>${client.debt > 0 ? '<span class="badge badge-danger">' + formatNumber(Math.round(client.debt)) + ' so\'m</span>' : '<span class="badge badge-success">Qarz yo\'q</span>'}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editClient(${client.id})" style="padding: 6px 12px; margin: 2px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteClient(${client.id})" style="padding: 6px 12px; margin: 2px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            updateClientsForPayments();
        };
        
        // To'lov sahifasi uchun mijozlar ro'yxatini yangilash
        const updateClientsForPayments = function() {
            const clients = appData.clients;
            const paymentClientSelect = document.getElementById('paymentClient');
            
            if (!paymentClientSelect) return;
            
            paymentClientSelect.innerHTML = '<option value="">Mijozni tanlang</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                paymentClientSelect.appendChild(option);
            });
        };
        
        // Sotuv tarixini yangilash
        const updateSalesHistory = function() {
            const sales = appData.sales;
            const tbody = document.getElementById('salesHistoryBody');
            
            if (!tbody) return;
            
            tbody.innerHTML = '';
            checkEmptyState('salesHistoryEmpty', sales);
            
            sales.forEach(sale => {
                const row = document.createElement('tr');
                
                const totalAmount = (sale.price_per_unit || 0) * (sale.quantity || 0);
                const paid = sale.paid || 0;
                const debt = totalAmount - paid;
                
                row.innerHTML = `
                    <td>${formatDate(sale.date)}</td>
                    <td>${sale.client_name}</td>
                    <td>${sale.product_type}</td>
                    <td>${formatNumber(sale.quantity)} dona</td>
                    <td>${formatNumber(Math.round(totalAmount))} so'm</td>
                    <td>${formatNumber(Math.round(paid))} so'm</td>
                    <td>${debt > 0 ? '<span class="badge badge-danger">' + formatNumber(Math.round(debt)) + ' so\'m</span>' : '<span class="badge badge-success">To\'langan</span>'}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteSale(${sale.id})" style="padding: 6px 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        };
        
        // Braklar sahifasini yangilash
        const updateReturnsPage = function() {
            const defects = appData.defects;
            const workshopReturns = appData.workshopReturns;
            const returnsTbody = document.getElementById('returnsHistoryBody');
            
            if (returnsTbody) {
                returnsTbody.innerHTML = '';
                checkEmptyState('returnsHistoryEmpty', [...defects, ...workshopReturns]);
                
                const allReturns = [...defects, ...workshopReturns].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                allReturns.forEach(ret => {
                    const row = document.createElement('tr');
                    
                    let typeText = '';
                    let clientOrWorkshop = '';
                    
                    if (ret.type === 'defect') {
                        typeText = 'Mijozdan brak';
                        clientOrWorkshop = ret.client_name || 'Noma\'lum mijoz';
                    } else {
                        typeText = 'Sexga qaytarish';
                        const workshops = appData.workshops;
                        const workshop = workshops.find(w => w.id == ret.workshop_id);
                        clientOrWorkshop = workshop ? workshop.name : 'Noma\'lum sex';
                    }
                    
                    row.innerHTML = `
                        <td>${formatDate(ret.date)}</td>
                        <td>${typeText}</td>
                        <td>${clientOrWorkshop}</td>
                        <td>${ret.product_type}</td>
                        <td>${ret.quantity} dona</td>
                        <td>${ret.reason || ret.note || ''}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteReturn(${ret.id}, '${ret.type}')" style="padding: 6px 12px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    returnsTbody.appendChild(row);
                });
            }
            
            const today = new Date().toISOString().split('T')[0];
            const defectDate = document.getElementById('defectDate');
            if (defectDate && !defectDate.value) {
                defectDate.value = today;
            }
        };
        
        // Qarzlar sahifasini yangilash
        const updateDebtsPage = function() {
            const workshops = appData.workshops;
            const workshopDebtsBody = document.getElementById('workshopDebtsBody');
            
            if (workshopDebtsBody) {
                workshopDebtsBody.innerHTML = '';
                checkEmptyState('workshopDebtsEmpty', workshops);
                
                workshops.forEach(workshop => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${workshop.name}</td>
                        <td>${formatNumber(Math.round(workshop.total_purchased || 0))} so'm</td>
                        <td>${formatNumber(Math.round(workshop.total_paid || 0))} so'm</td>
                        <td>${formatNumber(Math.round(workshop.defect_deductions || 0))} so'm</td>
                        <td>${workshop.debt > 0 ? '<span class="badge badge-danger">' + formatNumber(Math.round(workshop.debt)) + ' so\'m</span>' : '<span class="badge badge-success">Qarz yo\'q</span>'}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="showDebtPaymentModal('workshop', ${workshop.id}, '${workshop.name}', ${workshop.debt || 0})" ${workshop.debt <= 0 ? 'disabled' : ''} style="padding: 6px 12px;">
                                <i class="fas fa-money-bill-wave"></i>
                            </button>
                        </td>
                    `;
                    
                    workshopDebtsBody.appendChild(row);
                });
            }
            
            const clients = appData.clients;
            const clientDebtsBody = document.getElementById('clientDebtsBody');
            
            if (clientDebtsBody) {
                clientDebtsBody.innerHTML = '';
                checkEmptyState('clientDebtsEmpty', clients);
                
                clients.forEach(client => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${client.name}</td>
                        <td>${formatNumber(Math.round(client.total_purchased || 0))} so'm</td>
                        <td>${formatNumber(Math.round(client.total_paid || 0))} so'm</td>
                        <td>${formatNumber(Math.round(client.defect_deductions || 0))} so'm</td>
                        <td>${client.debt > 0 ? '<span class="badge badge-danger">' + formatNumber(Math.round(client.debt)) + ' so\'m</span>' : '<span class="badge badge-success">Qarz yo\'q</span>'}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="showDebtPaymentModal('client', ${client.id}, '${client.name}', ${client.debt || 0})" ${client.debt <= 0 ? 'disabled' : ''} style="padding: 6px 12px;">
                                <i class="fas fa-money-bill-wave"></i>
                            </button>
                        </td>
                    `;
                    
                    clientDebtsBody.appendChild(row);
                });
            }
            
            const payments = appData.payments;
            const paymentsTbody = document.getElementById('paymentsHistory');
            
            if (paymentsTbody) {
                paymentsTbody.innerHTML = '';
                checkEmptyState('paymentsHistoryEmpty', payments);
                
                const recentPayments = payments.slice(-10).reverse();
                
                recentPayments.forEach(payment => {
                    const row = document.createElement('tr');
                    
                    let fromTo = '';
                    
                    if (payment.type === 'workshop') {
                        const workshops = appData.workshops;
                        const workshop = workshops.find(w => w.id == payment.workshop_id);
                        fromTo = workshop ? workshop.name : 'Noma\'lum sex';
                    } else {
                        const clients = appData.clients;
                        const client = clients.find(c => c.id == payment.client_id);
                        fromTo = client ? client.name : 'Noma\'lum mijoz';
                    }
                    
                    row.innerHTML = `
                        <td>${formatDate(payment.date)}</td>
                        <td>${fromTo}</td>
                        <td>${formatNumber(Math.round(payment.amount))} so'm</td>
                        <td>${payment.note || ''}</td>
                    `;
                    
                    paymentsTbody.appendChild(row);
                });
            }
            
            const today = new Date().toISOString().split('T')[0];
            const paymentDate = document.getElementById('paymentDate');
            if (paymentDate && !paymentDate.value) {
                paymentDate.value = today;
            }
            
            const debtPaymentDate = document.getElementById('debtPaymentDate');
            if (debtPaymentDate && !debtPaymentDate.value) {
                debtPaymentDate.value = today;
            }
        };
        
        // Mijoz sahifasini yangilash
        const updateClientPage = function() {
            if (!currentUser) return;
            
            document.getElementById('clientIdDisplay').textContent = currentUser.id;
            document.getElementById('clientNameDisplay').textContent = currentUser.name;
            
            document.getElementById('clientIdDisplay2').textContent = currentUser.id;
            document.getElementById('clientNameDisplay2').textContent = currentUser.name;
            document.getElementById('clientPhoneDisplay').textContent = currentUser.phone || '-';
            
            document.getElementById('clientTotalProducts').textContent = formatNumber(currentUser.total_purchased_quantity || 0) + ' dona';
            document.getElementById('clientTotalDebt').textContent = formatNumber(Math.round(currentUser.debt || 0)) + ' so\'m';
            document.getElementById('clientTotalPaid').textContent = formatNumber(Math.round(currentUser.total_paid || 0)) + ' so\'m';
            
            document.getElementById('clientTotalProducts2').textContent = formatNumber(currentUser.total_purchased_quantity || 0) + ' dona';
            document.getElementById('clientTotalDebt2').textContent = formatNumber(Math.round(currentUser.debt || 0)) + ' so\'m';
            document.getElementById('clientTotalPaid2').textContent = formatNumber(Math.round(currentUser.total_paid || 0)) + ' so\'m';
            
            // Mijozning mahsulotlarini ko'rsatish
            const sales = appData.sales;
            const clientSales = sales.filter(sale => sale.client_id == currentUser.id);
            const productsList = document.getElementById('clientProductsList');
            
            if (productsList) {
                productsList.innerHTML = '';
                checkEmptyState('clientProductsEmpty', clientSales);
                
                clientSales.forEach(sale => {
                    const productItem = document.createElement('div');
                    productItem.className = 'client-product-item';
                    
                    productItem.innerHTML = `
                        <div class="client-product-info">
                            <h4>${sale.product_type}</h4>
                            <p>Sana: ${formatDate(sale.date)}</p>
                            <p>Miqdor: ${sale.quantity} dona</p>
                            <p>Narxi: ${formatNumber(Math.round(sale.price_per_unit))} so'm/dona</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">
                                ${formatNumber(Math.round(sale.quantity * sale.price_per_unit))} so'm
                            </div>
                            <div style="color: #666; font-size: 12px;">
                                ${sale.paid < sale.quantity * sale.price_per_unit ? 'Qarzdor' : 'To\'langan'}
                            </div>
                        </div>
                    `;
                    
                    productsList.appendChild(productItem);
                });
            }
            
            // Mijozning to'lovlarini ko'rsatish
            const payments = appData.payments;
            const clientPayments = payments.filter(payment => payment.type === 'client' && payment.client_id == currentUser.id);
            const paymentsList = document.getElementById('clientPaymentsList');
            
            if (paymentsList) {
                paymentsList.innerHTML = '';
                checkEmptyState('clientPaymentsEmpty', clientPayments);
                
                clientPayments.forEach(payment => {
                    const paymentItem = document.createElement('div');
                    paymentItem.className = 'payment-item';
                    
                    paymentItem.innerHTML = `
                        <div>
                            <h4>${formatDate(payment.date)}</h4>
                            <p>${payment.note || 'Qarz to\'lovi'}</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--success);">
                                ${formatNumber(Math.round(payment.amount))} so'm
                            </div>
                            <div style="color: #666; font-size: 12px;">
                                To'lov
                            </div>
                        </div>
                    `;
                    
                    paymentsList.appendChild(paymentItem);
                });
            }
        };
        
        // Sex qo'shish
        const addWorkshop = async function() {
            try {
                const name = document.getElementById('workshopName').value.trim();
                const phone = document.getElementById('workshopPhone').value.trim();
                const address = document.getElementById('workshopAddress').value.trim();
                
                if (!name) {
                    showMessage('Sex nomini kiriting!', 'error');
                    return;
                }
                
                let workshops = [...appData.workshops];
                
                let newId = 1;
                if (workshops.length > 0) {
                    newId = Math.max(...workshops.map(w => w.id)) + 1;
                }
                
                const newWorkshop = {
                    id: newId,
                    name: name,
                    phone: phone,
                    address: address,
                    debt: 0,
                    total_purchased: 0,
                    total_paid: 0,
                    defect_deductions: 0,
                    avg_price: 0
                };
                
                workshops.push(newWorkshop);
                
                await DB.save('workshops', workshops);
                appData.workshops = workshops;
                
                document.getElementById('workshopName').value = '';
                document.getElementById('workshopPhone').value = '';
                document.getElementById('workshopAddress').value = '';
                
                updateWorkshops();
                updateDashboard();
                
                await addActivity('workshop_add', `"${name}" sexi qo'shildi`);
                
                showMessage(`"${name}" sexi muvaffaqiyatli qo'shildi!`);
            } catch (error) {
                console.error('Sex qo\'shishda xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // Sexni tahrirlash
        const editWorkshop = async function(id) {
            try {
                let workshops = [...appData.workshops];
                const workshop = workshops.find(w => w.id == id);
                
                if (!workshop) {
                    showMessage('Sex topilmadi!', 'error');
                    return;
                }
                
                const newName = prompt('Yangi sex nomi:', workshop.name);
                if (!newName || newName.trim() === '') {
                    showMessage('Sex nomi bo\'sh bo\'lishi mumkin emas!', 'error');
                    return;
                }
                
                const newPhone = prompt('Yangi telefon raqami:', workshop.phone || '');
                const newAddress = prompt('Yangi manzil:', workshop.address || '');
                
                workshop.name = newName.trim();
                workshop.phone = newPhone || '';
                workshop.address = newAddress || '';
                
                await DB.save('workshops', workshops);
                appData.workshops = workshops;
                
                updateWorkshops();
                updateDashboard();
                
                await addActivity('workshop_edit', `"${workshop.name}" sexi o'zgartirildi`);
                
                showMessage('Sex ma\'lumotlari muvaffaqiyatli o\'zgartirildi!');
            } catch (error) {
                console.error('Sexni tahrirlashda xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // Sexni o'chirish
        const deleteWorkshop = async function(id) {
            try {
                let workshops = [...appData.workshops];
                const workshopIndex = workshops.findIndex(w => w.id == id);
                
                if (workshopIndex === -1) {
                    showMessage('Sex topilmadi!', 'error');
                    return;
                }
                
                const workshopName = workshops[workshopIndex].name;
                
                const incomes = appData.incomes;
                const workshopIncomes = incomes.filter(income => income.workshop_id == id);
                
                if (workshopIncomes.length > 0) {
                    showMessage(`Ushbu sexda ${workshopIncomes.length} ta kirim mavjud. Avval kirimlarni o'chiring!`, 'error');
                    return;
                }
                
                if (!confirm(`"${workshopName}" sexini o'chirishni istaysizmi?`)) {
                    return;
                }
                
                workshops.splice(workshopIndex, 1);
                
                await DB.save('workshops', workshops);
                appData.workshops = workshops;
                
                updateWorkshops();
                updateDashboard();
                
                await addActivity('workshop_delete', `"${workshopName}" sexi o'chirildi`);
                
                showMessage(`"${workshopName}" sexi muvaffaqiyatli o'chirildi!`);
            } catch (error) {
                console.error('Sexni o\'chirishda xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // Kirim qo'shish
        const addIncome = async function() {
            try {
                const date = document.getElementById('incomeDate').value;
                const workshopId = parseInt(document.getElementById('incomeWorkshop').value);
                const productType = document.getElementById('incomeProductType').value.trim().toUpperCase();
                const quantity = parseInt(document.getElementById('incomeQuantity').value);
                const pricePerUnit = parseInt(document.getElementById('incomePrice').value);
                const paid = parseInt(document.getElementById('incomePaid').value) || 0;
                
                if (!date) {
                    showMessage('Sana tanlang!', 'error');
                    return;
                }
                
                if (!workshopId) {
                    showMessage('Sex tanlang!', 'error');
                    return;
                }
                
                if (!productType) {
                    showMessage('Halat turini kiriting!', 'error');
                    return;
                }
                
                if (!quantity || quantity <= 0) {
                    showMessage('To\'g\'ri miqdor kiriting!', 'error');
                    return;
                }
                
                if (!pricePerUnit || pricePerUnit < 0) {
                    showMessage('To\'g\'ri narx kiriting!', 'error');
                    return;
                }
                
                let workshops = [...appData.workshops];
                const workshop = workshops.find(w => w.id == workshopId);
                
                if (!workshop) {
                    showMessage('Tanlangan sex topilmadi!', 'error');
                    return;
                }
                
                let incomes = [...appData.incomes];
                
                let newId = 1;
                if (incomes.length > 0) {
                    newId = Math.max(...incomes.map(i => i.id)) + 1;
                }
                
                const totalAmount = pricePerUnit * quantity;
                const debt = totalAmount - paid;
                
                const newIncome = {
                    id: newId,
                    date: date,
                    timestamp: new Date().toISOString(),
                    workshop_id: workshopId,
                    workshop_name: workshop.name,
                    product_type: productType,
                    quantity: quantity,
                    price_per_unit: pricePerUnit,
                    total_amount: totalAmount,
                    paid: paid,
                    debt: debt
                };
                
                incomes.push(newIncome);
                await DB.save('incomes', incomes);
                appData.incomes = incomes;
                
                workshop.total_purchased = (workshop.total_purchased || 0) + totalAmount;
                workshop.total_paid = (workshop.total_paid || 0) + paid;
                workshop.debt = (workshop.debt || 0) + debt;
                
                await DB.save('workshops', workshops);
                appData.workshops = workshops;
                
                // OMBOR MA'LUMOTLARINI YANGILASH
                let storage = [...appData.storage];
                const storageKey = `${workshopId}_${productType}`;
                let storageItem = storage.find(item => item.key === storageKey);
                
                if (!storageItem) {
                    storageItem = {
                        key: storageKey,
                        workshop_id: workshopId,
                        workshop_name: workshop.name,
                        product_type: productType,
                        total_in: 0,
                        total_out: 0,
                        defects: 0,
                        workshop_returns: 0,
                        current_balance: 0,
                        avg_price: 0,
                        total_cost: 0
                    };
                    storage.push(storageItem);
                }
                
                const previousTotalCost = storageItem.total_cost || 0;
                const newTotalIn = (storageItem.total_in || 0) + quantity;
                const newTotalCost = previousTotalCost + totalAmount;
                
                storageItem.total_in = newTotalIn;
                storageItem.current_balance = (storageItem.current_balance || 0) + quantity;
                storageItem.avg_price = newTotalIn > 0 ? newTotalCost / newTotalIn : 0;
                storageItem.total_cost = newTotalCost;
                
                await DB.save('storage', storage);
                appData.storage = storage;
                
                document.getElementById('incomeProductType').value = '';
                document.getElementById('incomeQuantity').value = '';
                document.getElementById('incomePrice').value = '';
                document.getElementById('incomePaid').value = '';
                
                updateIncomePage();
                updateDashboard();
                updateStorage();
                updateProductTypesForSales();
                
                await addActivity('income', `${workshop.name} sexidan ${quantity} dona ${productType} kirim qilindi`);
                
                showMessage(`${quantity} dona ${productType} kirim qilindi. Sex qarzi: ${formatNumber(Math.round(debt))} so'm`);
            } catch (error) {
                console.error('Kirim qo\'shishda xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // Kirimni o'chirish
        const deleteIncome = async function(id) {
            try {
                let incomes = [...appData.incomes];
                const incomeIndex = incomes.findIndex(i => i.id == id);
                
                if (incomeIndex === -1) {
                    showMessage('Kirim topilmadi!', 'error');
                    return;
                }
                
                const income = incomes[incomeIndex];
                
                if (!confirm(`Ushbu kirimni o'chirishni istaysizmi? (${income.product_type} - ${income.quantity} dona)`)) {
                    return;
                }
                
                let workshops = [...appData.workshops];
                const workshop = workshops.find(w => w.id == income.workshop_id);
                
                if (workshop) {
                    const totalAmount = (income.price_per_unit || 0) * (income.quantity || 0);
                    const paid = income.paid || 0;
                    const debt = totalAmount - paid;
                    
                    workshop.total_purchased = Math.max(0, (workshop.total_purchased || 0) - totalAmount);
                    workshop.total_paid = Math.max(0, (workshop.total_paid || 0) - paid);
                    workshop.debt = Math.max(0, (workshop.debt || 0) - debt);
                    
                    await DB.save('workshops', workshops);
                    appData.workshops = workshops;
                }
                
                let storage = [...appData.storage];
                const storageKey = `${income.workshop_id}_${income.product_type}`;
                const storageItem = storage.find(item => item.key === storageKey);
                
                if (storageItem) {
                    const totalAmount = (income.price_per_unit || 0) * (income.quantity || 0);
                    const previousTotalCost = storageItem.total_cost || 0;
                    const newTotalIn = Math.max(0, (storageItem.total_in || 0) - income.quantity);
                    const newTotalCost = Math.max(0, previousTotalCost - totalAmount);
                    
                    storageItem.total_in = newTotalIn;
                    storageItem.current_balance = Math.max(0, (storageItem.current_balance || 0) - income.quantity);
                    storageItem.avg_price = newTotalIn > 0 ? newTotalCost / newTotalIn : 0;
                    storageItem.total_cost = newTotalCost;
                    
                    if (storageItem.total_in === 0 && storageItem.total_out === 0 && storageItem.defects === 0) {
                        const storageIndex = storage.findIndex(item => item.key === storageKey);
                        storage.splice(storageIndex, 1);
                    }
                    
                    await DB.save('storage', storage);
                    appData.storage = storage;
                }
                
                incomes.splice(incomeIndex, 1);
                await DB.save('incomes', incomes);
                appData.incomes = incomes;
                
                updateIncomePage();
                updateDashboard();
                updateStorage();
                updateProductTypesForSales();
                
                await addActivity('income_delete', `${income.workshop_name} sexidan qilingan ${income.quantity} dona ${income.product_type} kirimi o'chirildi`);
                
                showMessage('Kirim muvaffaqiyatli o\'chirildi!');
            } catch (error) {
                console.error('Kirimni o\'chirishda xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // Mijoz qo'shish (MODAL ORQALI)
        const addClient = async function() {
            try {
                const name = document.getElementById('modalClientName').value.trim();
                const phone = document.getElementById('modalClientPhone').value.trim();
                
                if (!name) {
                    showMessage('Mijoz nomini kiriting!', 'error');
                    return;
                }
                
                let clients = [...appData.clients];
                
                const newId = generateClientId();
                
                const newClient = {
                    id: newId,
                    name: name,
                    phone: phone,
                    created: new Date().toISOString(),
                    total_purchased: 0,
                    total_purchased_quantity: 0,
                    total_paid: 0,
                    defect_deductions: 0,
                    debt: 0
                };
                
                clients.push(newClient);
                await DB.save('clients', clients);
                appData.clients = clients;
                
                document.getElementById('addClientModal').style.display = 'none';
                document.getElementById('modalClientName').value = '';
                document.getElementById('modalClientPhone').value = '';
                
                updateClientsTab();
                updateSalesPage();
                
                await addActivity('client_add', `"${name}" mijozi qo'shildi (ID: ${newId})`);
                
                showMessage(`"${name}" mijozi muvaffaqiyatli qo'shildi! Mijoz ID: ${newId}`);
            } catch (error) {
                console.error('Mijoz qo\'shishda xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // Yangi mijoz qo'shish (tab ichidagi)
        const addClientFromTab = async function() {
            try {
                const name = document.getElementById('newClientName').value.trim();
                const phone = document.getElementById('newClientPhone').value.trim();
                
                if (!name) {
                    showMessage('Mijoz nomini kiriting!', 'error');
                    return;
                }
                
                let clients = [...appData.clients];
                const newId = generateClientId();
                
                const newClient = {
                    id: newId,
                    name: name,
                    phone: phone,
                    created: new Date().toISOString(),
                    total_purchased: 0,
                    total_purchased_quantity: 0,
                    total_paid: 0,
                    defect_deductions: 0,
                    debt: 0
                };
                
                clients.push(newClient);
                await DB.save('clients', clients);
                appData.clients = clients;
                
                document.getElementById('newClientName').value = '';
                document.getElementById('newClientPhone').value = '';
                
                updateClientsTab();
                updateSalesPage();
                
                await addActivity('client_add', `"${name}" mijozi qo'shildi (ID: ${newId})`);
                
                showMessage(`"${name}" mijozi muvaffaqiyatli qo'shildi! Mijoz ID: <strong>${newId}</strong>`);
            } catch (error) {
                console.error('Mijoz qo\'shishda xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // Mijozni tahrirlash
        const editClient = async function(id) {
            try {
                let clients = [...appData.clients];
                const client = clients.find(c => c.id == id);
                
                if (!client) {
                    showMessage('Mijoz topilmadi!', 'error');
                    return;
                }
                
                const newName = prompt('Yangi mijoz nomi:', client.name);
                if (!newName || newName.trim() === '') {
                    showMessage('Mijoz nomi bo\'sh bo\'lishi mumkin emas!', 'error');
                    return;
                }
                
                const newPhone = prompt('Yangi telefon raqami:', client.phone || '');
                
                client.name = newName.trim();
                client.phone = newPhone || '';
                
                await DB.save('clients', clients);
                appData.clients = clients;
                
                updateClientsTab();
                updateSalesPage();
                
                await addActivity('client_edit', `"${client.name}" mijozi o'zgartirildi`);
                
                showMessage('Mijoz ma\'lumotlari muvaffaqiyatli o\'zgartirildi!');
            } catch (error) {
                console.error('Mijozni tahrirlashda xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // Mijozni o'chirish
        const deleteClient = async function(id) {
            try {
                let clients = [...appData.clients];
                const clientIndex = clients.findIndex(c => c.id == id);
                
                if (clientIndex === -1) {
                    showMessage('Mijoz topilmadi!', 'error');
                    return;
                }
                
                const clientName = clients[clientIndex].name;
                
                const sales = appData.sales;
                const clientSales = sales.filter(sale => sale.client_id == id);
                
                if (clientSales.length > 0) {
                    showMessage(`Ushbu mijozda ${clientSales.length} ta sotuv mavjud. Avval sotuvlarni o'chiring!`, 'error');
                    return;
                }
                
                if (!confirm(`"${clientName}" mijoziini o'chirishni istaysizmi?`)) {
                    return;
                }
                
                clients.splice(clientIndex, 1);
                await DB.save('clients', clients);
                appData.clients = clients;
                
                updateClientsTab();
                
                await addActivity('client_delete', `"${clientName}" mijozi o'chirildi`);
                
                showMessage(`"${clientName}" mijozi muvaffaqiyatli o'chirildi!`);
            } catch (error) {
                console.error('Mijozni o\'chirishda xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // Sotuv qo'shish
        const addSale = async function() {
            try {
                const clientId = parseInt(document.getElementById('saleClient').value);
                const date = document.getElementById('saleDate').value;
                const productType = document.getElementById('saleProductType').value;
                const quantity = parseInt(document.getElementById('saleQuantity').value);
                const pricePerUnit = parseInt(document.getElementById('salePrice').value);
                const paid = parseInt(document.getElementById('salePaid').value) || 0;
                const note = document.getElementById('saleNote').value.trim();
                
                if (!clientId) {
                    showMessage('Mijoz tanlang!', 'error');
                    return;
                }
                
                if (!date) {
                    showMessage('Sana tanlang!', 'error');
                    return;
                }
                
                if (!productType) {
                    showMessage('Halat turini tanlang!', 'error');
                    return;
                }
                
                if (!quantity || quantity <= 0) {
                    showMessage('To\'g\'ri miqdor kiriting!', 'error');
                    return;
                }
                
                if (!pricePerUnit || pricePerUnit < 0) {
                    showMessage('To\'g\'ri narx kiriting!', 'error');
                    return;
                }
                
                let clients = [...appData.clients];
                const client = clients.find(c => c.id == clientId);
                
                if (!client) {
                    showMessage('Tanlangan mijoz topilmadi!', 'error');
                    return;
                }
                
                const productSelect = document.getElementById('saleProductType');
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const storageKey = selectedOption.value;
                const workshopId = selectedOption.getAttribute('data-workshop-id');
                const workshopName = selectedOption.getAttribute('data-workshop-name');
                const actualProductType = selectedOption.getAttribute('data-product-type');
                
                if (!storageKey) {
                    showMessage('Halat turini tanlang!', 'error');
                    return;
                }
                
                let storage = [...appData.storage];
                const storageItem = storage.find(item => item.key === storageKey);
                
                if (!storageItem) {
                    showMessage('Ushbu turdagi mahsulot omborda mavjud emas!', 'error');
                    return;
                }
                
                if (storageItem.current_balance < quantity) {
                    showMessage(`Ombor qoldig'i yetarli emas! Mavjud: ${storageItem.current_balance} dona`, 'error');
                    return;
                }
                
                let sales = [...appData.sales];
                
                let newId = 1;
                if (sales.length > 0) {
                    newId = Math.max(...sales.map(s => s.id)) + 1;
                }
                
                const totalAmount = pricePerUnit * quantity;
                const debt = totalAmount - paid;
                
                const newSale = {
                    id: newId,
                    date: date,
                    timestamp: new Date().toISOString(),
                    client_id: clientId,
                    client_name: client.name,
                    workshop_id: workshopId,
                    workshop_name: workshopName,
                    product_type: actualProductType,
                    storage_key: storageKey,
                    quantity: quantity,
                    price_per_unit: pricePerUnit,
                    total_amount: totalAmount,
                    paid: paid,
                    debt: debt,
                    note: note
                };
                
                sales.push(newSale);
                await DB.save('sales', sales);
                appData.sales = sales;
                
                client.total_purchased = (client.total_purchased || 0) + totalAmount;
                client.total_purchased_quantity = (client.total_purchased_quantity || 0) + quantity;
                client.total_paid = (client.total_paid || 0) + paid;
                client.debt = (client.debt || 0) + debt;
                
                await DB.save('clients', clients);
                appData.clients = clients;
                
                storageItem.total_out = (storageItem.total_out || 0) + quantity;
                storageItem.current_balance = (storageItem.current_balance || 0) - quantity;
                
                await DB.save('storage', storage);
                appData.storage = storage;
                
                document.getElementById('saleQuantity').value = '';
                document.getElementById('salePrice').value = '';
                document.getElementById('salePaid').value = '';
                document.getElementById('saleNote').value = '';
                
                updateSalesPage();
                updateDashboard();
                updateStorage();
                updateProductTypesForSales();
                
                await addActivity('sale', `${client.name} mijoziga ${quantity} dona ${actualProductType} sotildi`);
                
                showMessage(`${quantity} dona ${actualProductType} sotildi. Mijoz qarzi: ${formatNumber(Math.round(debt))} so'm`);
            } catch (error) {
                console.error('Sotuv qo\'shishda xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // Sotuvni o'chirish
        const deleteSale = async function(id) {
            try {
                let sales = [...appData.sales];
                const saleIndex = sales.findIndex(s => s.id == id);
                
                if (saleIndex === -1) {
                    showMessage('Sotuv topilmadi!', 'error');
                    return;
                }
                
                const sale = sales[saleIndex];
                
                if (!confirm(`Ushbu sotuvni o'chirishni istaysizmi? (${sale.client_name} - ${sale.product_type} - ${sale.quantity} dona)`)) {
                    return;
                }
                
                let clients = [...appData.clients];
                const client = clients.find(c => c.id == sale.client_id);
                
                if (client) {
                    client.total_purchased = Math.max(0, (client.total_purchased || 0) - sale.total_amount);
                    client.total_purchased_quantity = Math.max(0, (client.total_purchased_quantity || 0) - sale.quantity);
                    client.total_paid = Math.max(0, (client.total_paid || 0) - sale.paid);
                    client.debt = Math.max(0, (client.debt || 0) - sale.debt);
                    await DB.save('clients', clients);
                    appData.clients = clients;
                }
                
                let storage = [...appData.storage];
                const storageItem = storage.find(item => item.key === sale.storage_key);
                
                if (storageItem) {
                    storageItem.total_out = Math.max(0, (storageItem.total_out || 0) - sale.quantity);
                    storageItem.current_balance = (storageItem.current_balance || 0) + sale.quantity;
                    await DB.save('storage', storage);
                    appData.storage = storage;
                }
                
                sales.splice(saleIndex, 1);
                await DB.save('sales', sales);
                appData.sales = sales;
                
                updateSalesPage();
                updateDashboard();
                updateStorage();
                updateProductTypesForSales();
                
                await addActivity('sale_delete', `${sale.client_name} mijoziga qilingan ${sale.quantity} dona ${sale.product_type} sotuvi o'chirildi`);
                
                showMessage('Sotuv muvaffaqiyatli o\'chirildi!');
            } catch (error) {
                console.error('Sotuvni o\'chirishda xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // Brak qaydnomasi (Mijozdan brak olib kelish)
        const processDefect = async function() {
            try {
                const clientId = parseInt(document.getElementById('defectClient').value);
                const workshopId = parseInt(document.getElementById('defectWorkshop').value);
                const productType = document.getElementById('defectProductType').value.trim().toUpperCase();
                const quantity = parseInt(document.getElementById('defectQuantity').value);
                const reason = document.getElementById('defectReason').value;
                const note = document.getElementById('defectNote').value.trim();
                
                if (!clientId) {
                    showMessage('Mijoz tanlang!', 'error');
                    return;
                }
                
                if (!workshopId) {
                    showMessage('Sex tanlang!', 'error');
                    return;
                }
                
                if (!productType) {
                    showMessage('Halat turini kiriting!', 'error');
                    return;
                }
                
                if (!quantity || quantity <= 0) {
                    showMessage('To\'g\'ri miqdor kiriting!', 'error');
                    return;
                }
                
                if (!reason) {
                    showMessage('Sababni tanlang!', 'error');
                    return;
                }
                
                let clients = [...appData.clients];
                const client = clients.find(c => c.id == clientId);
                
                if (!client) {
                    showMessage('Tanlangan mijoz topilmadi!', 'error');
                    return;
                }
                
                let workshops = [...appData.workshops];
                const workshop = workshops.find(w => w.id == workshopId);
                
                if (!workshop) {
                    showMessage('Tanlangan sex topilmadi!', 'error');
                    return;
                }
                
                // Mijozdan qancha mahsulot sotganini tekshirish
                const sales = appData.sales;
                const clientSales = sales.filter(sale => sale.client_id == clientId && sale.product_type === productType && sale.workshop_id == workshopId);
                
                let totalSold = 0;
                clientSales.forEach(sale => {
                    totalSold += sale.quantity || 0;
                });
                
                const defects = appData.defects;
                const clientDefects = defects.filter(defect => defect.client_id == clientId && defect.product_type === productType && defect.workshop_id == workshopId);
                
                let totalDefects = 0;
                clientDefects.forEach(defect => {
                    totalDefects += defect.quantity || 0;
                });
                
                if (totalSold - totalDefects < quantity) {
                    showMessage(`Mijozdan olinayotgan brak miqdori sotilganidan ko'p! Sotilgan: ${totalSold} dona, Avval olingan brak: ${totalDefects} dona, Qolgan: ${totalSold - totalDefects} dona`, 'error');
                    return;
                }
                
                let defectsDB = [...appData.defects];
                
                let newId = 1;
                if (defectsDB.length > 0) {
                    newId = Math.max(...defectsDB.map(d => d.id)) + 1;
                }
                
                const today = new Date().toISOString().split('T')[0];
                
                const newDefect = {
                    id: newId,
                    date: today,
                    timestamp: new Date().toISOString(),
                    type: 'defect',
                    client_id: clientId,
                    client_name: client.name,
                    workshop_id: workshopId,
                    workshop_name: workshop.name,
                    product_type: productType,
                    quantity: quantity,
                    reason: reason,
                    note: note
                };
                
                defectsDB.push(newDefect);
                await DB.save('defects', defectsDB);
                appData.defects = defectsDB;
                
                // Mijoz qarzini kamaytirish
                let storage = [...appData.storage];
                const storageKey = `${workshopId}_${productType}`;
                const storageItem = storage.find(item => item.key === storageKey);
                
                let defectAmount = 0;
                if (storageItem) {
                    defectAmount = (storageItem.avg_price || workshop.avg_price || 0) * quantity;
                    
                    // OMBORGA QO'SHISH (mijozdan olib kelingan brak omborga qo'shiladi)
                    storageItem.defects = (storageItem.defects || 0) + quantity;
                    storageItem.current_balance = (storageItem.current_balance || 0) + quantity;
                    await DB.save('storage', storage);
                    appData.storage = storage;
                } else {
                    defectAmount = (workshop.avg_price || 0) * quantity;
                }
                
                client.defect_deductions = (client.defect_deductions || 0) + defectAmount;
                client.debt = Math.max(0, (client.debt || 0) - defectAmount);
                await DB.save('clients', clients);
                appData.clients = clients;
                
                document.getElementById('defectProductType').value = '';
                document.getElementById('defectQuantity').value = '';
                document.getElementById('defectNote').value = '';
                
                updateReturnsPage();
                updateDashboard();
                updateStorage();
                
                await addActivity('defect', `${client.name} mijozidan ${quantity} dona ${productType} brak olib kelindi`);
                
                showMessage(`${quantity} dona ${productType} brak ro'yxatga olindi. Mijoz qarzi ${formatNumber(Math.round(defectAmount))} so'm kamaytirildi.`);
            } catch (error) {
                console.error('Brak qaydnomasida xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // Sexga qaytarish (Brak mahsulotni sexga qaytarish)
        const processReturnToWorkshop = async function() {
            try {
                const workshopId = parseInt(document.getElementById('returnToWorkshopSelect').value);
                const productKey = document.getElementById('returnToWorkshopProduct').value;
                const quantity = parseInt(document.getElementById('returnToWorkshopQuantity').value);
                const note = document.getElementById('returnToWorkshopNote').value.trim();
                
                if (!workshopId) {
                    showMessage('Sex tanlang!', 'error');
                    return;
                }
                
                if (!productKey) {
                    showMessage('Halat turini tanlang!', 'error');
                    return;
                }
                
                if (!quantity || quantity <= 0) {
                    showMessage('To\'g\'ri miqdor kiriting!', 'error');
                    return;
                }
                
                let storage = [...appData.storage];
                const storageItem = storage.find(item => item.key === productKey);
                
                if (!storageItem) {
                    showMessage('Tanlangan mahsulot topilmadi!', 'error');
                    return;
                }
                
                if (storageItem.defects < quantity) {
                    showMessage(`Brak miqdori yetarli emas! Mavjud brak: ${storageItem.defects} dona`, 'error');
                    return;
                }
                
                let workshops = [...appData.workshops];
                const workshop = workshops.find(w => w.id == workshopId);
                
                if (!workshop) {
                    showMessage('Tanlangan sex topilmadi!', 'error');
                    return;
                }
                
                let workshopReturns = [...appData.workshopReturns];
                
                let newId = 1;
                if (workshopReturns.length > 0) {
                    newId = Math.max(...workshopReturns.map(r => r.id)) + 1;
                }
                
                const today = new Date().toISOString().split('T')[0];
                
                const newReturn = {
                    id: newId,
                    date: today,
                    timestamp: new Date().toISOString(),
                    type: 'workshop_return',
                    workshop_id: workshopId,
                    workshop_name: workshop.name,
                    product_type: storageItem.product_type,
                    quantity: quantity,
                    note: note
                };
                
                workshopReturns.push(newReturn);
                await DB.save('workshopReturns', workshopReturns);
                appData.workshopReturns = workshopReturns;
                
                // OMBORDAN CHIQARISH (brak mahsulot sexga qaytarilgani uchun ombordan chiqariladi)
                storageItem.defects = Math.max(0, (storageItem.defects || 0) - quantity);
                storageItem.workshop_returns = (storageItem.workshop_returns || 0) + quantity;
                storageItem.current_balance = Math.max(0, (storageItem.current_balance || 0) - quantity);
                
                await DB.save('storage', storage);
                appData.storage = storage;
                
                // Sex qarzini kamaytirish
                const returnAmount = (storageItem.avg_price || workshop.avg_price || 0) * quantity;
                workshop.defect_deductions = (workshop.defect_deductions || 0) + returnAmount;
                workshop.debt = Math.max(0, (workshop.debt || 0) - returnAmount);
                
                await DB.save('workshops', workshops);
                appData.workshops = workshops;
                
                document.getElementById('returnToWorkshopQuantity').value = '';
                document.getElementById('returnToWorkshopNote').value = '';
                
                updateReturnsPage();
                updateDashboard();
                updateStorage();
                
                await addActivity('workshop_return', `${quantity} dona ${storageItem.product_type} brak sexga qaytarildi`);
                
                showMessage(`${quantity} dona ${storageItem.product_type} sexga qaytarildi. Sex qarzi ${formatNumber(Math.round(returnAmount))} so'm kamaytirildi.`);
            } catch (error) {
                console.error('Sexga qaytarishda xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // Qaytishni o'chirish
        const deleteReturn = async function(id, type) {
            try {
                if (type === 'defect') {
                    let defects = [...appData.defects];
                    const defectIndex = defects.findIndex(d => d.id == id);
                    
                    if (defectIndex === -1) {
                        showMessage('Brak topilmadi!', 'error');
                        return;
                    }
                    
                    const defect = defects[defectIndex];
                    
                    if (!confirm(`Ushbu brakni o'chirishni istaysizmi? (${defect.client_name} - ${defect.product_type} - ${defect.quantity} dona)`)) {
                        return;
                    }
                    
                    // Mijoz qarzini qaytarish
                    let clients = [...appData.clients];
                    const client = clients.find(c => c.id == defect.client_id);
                    
                    if (client) {
                        let storage = [...appData.storage];
                        const storageKey = `${defect.workshop_id}_${defect.product_type}`;
                        const storageItem = storage.find(item => item.key === storageKey);
                        
                        let defectAmount = 0;
                        if (storageItem) {
                            defectAmount = (storageItem.avg_price || 0) * defect.quantity;
                            
                            // OMBORDAN CHIQARISH (brak olib tashlanadi)
                            storageItem.defects = Math.max(0, (storageItem.defects || 0) - defect.quantity);
                            storageItem.current_balance = Math.max(0, (storageItem.current_balance || 0) - defect.quantity);
                            await DB.save('storage', storage);
                            appData.storage = storage;
                        } else {
                            const workshops = appData.workshops;
                            const workshop = workshops.find(w => w.id == defect.workshop_id);
                            defectAmount = (workshop ? workshop.avg_price : 0) * defect.quantity;
                        }
                        
                        client.defect_deductions = Math.max(0, (client.defect_deductions || 0) - defectAmount);
                        client.debt = (client.debt || 0) + defectAmount;
                        await DB.save('clients', clients);
                        appData.clients = clients;
                    }
                    
                    defects.splice(defectIndex, 1);
                    await DB.save('defects', defects);
                    appData.defects = defects;
                    
                } else if (type === 'workshop_return') {
                    let workshopReturns = [...appData.workshopReturns];
                    const returnIndex = workshopReturns.findIndex(r => r.id == id);
                    
                    if (returnIndex === -1) {
                        showMessage('Qaytarish topilmadi!', 'error');
                        return;
                    }
                    
                    const returnItem = workshopReturns[returnIndex];
                    
                    if (!confirm(`Ushbu sexga qaytarishni o'chirishni istaysizmi? (${returnItem.workshop_name} - ${returnItem.product_type} - ${returnItem.quantity} dona)`)) {
                        return;
                    }
                    
                    // OMBORGA QAYTARISH (sexga qaytarilgan brak yana omborga qaytadi)
                    let storage = [...appData.storage];
                    const storageKey = `${returnItem.workshop_id}_${returnItem.product_type}`;
                    const storageItem = storage.find(item => item.key === storageKey);
                    
                    if (storageItem) {
                        storageItem.defects = (storageItem.defects || 0) + returnItem.quantity;
                        storageItem.workshop_returns = Math.max(0, (storageItem.workshop_returns || 0) - returnItem.quantity);
                        storageItem.current_balance = (storageItem.current_balance || 0) + returnItem.quantity;
                        await DB.save('storage', storage);
                        appData.storage = storage;
                        
                        // Sex qarzini qaytarish
                        let workshops = [...appData.workshops];
                        const workshop = workshops.find(w => w.id == returnItem.workshop_id);
                        
                        if (workshop) {
                            const returnAmount = (storageItem.avg_price || workshop.avg_price || 0) * returnItem.quantity;
                            workshop.defect_deductions = Math.max(0, (workshop.defect_deductions || 0) - returnAmount);
                            workshop.debt = (workshop.debt || 0) + returnAmount;
                            await DB.save('workshops', workshops);
                            appData.workshops = workshops;
                        }
                    }
                    
                    workshopReturns.splice(returnIndex, 1);
                    await DB.save('workshopReturns', workshopReturns);
                    appData.workshopReturns = workshopReturns;
                }
                
                updateReturnsPage();
                updateDashboard();
                updateStorage();
                
                await addActivity('return_delete', 'Brak qaydnomasi o\'chirildi');
                
                showMessage('Brak qaydnomasi muvaffaqiyatli o\'chirildi!');
            } catch (error) {
                console.error('Brakni o\'chirishda xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // Qarz to'lov modalini ko'rsatish
        const showDebtPaymentModal = function(type, id, name, debt) {
            document.getElementById('debtPaymentModalTitle').textContent = `${name} - Qarz to'lash`;
            document.getElementById('currentDebtAmount').textContent = formatNumber(Math.round(debt)) + ' so\'m';
            document.getElementById('debtPaymentAmount').value = Math.round(debt);
            document.getElementById('debtPaymentAmount').max = debt;
            document.getElementById('debtPaymentType').value = type;
            document.getElementById('debtPaymentId').value = id;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('debtPaymentDate').value = today;
            
            document.getElementById('debtPaymentModal').style.display = 'flex';
        };
        
        // Qarz to'lash
        const processDebtPayment = async function() {
            try {
                const type = document.getElementById('debtPaymentType').value;
                const id = parseInt(document.getElementById('debtPaymentId').value);
                const amount = parseInt(document.getElementById('debtPaymentAmount').value);
                const date = document.getElementById('debtPaymentDate').value;
                const note = document.getElementById('debtPaymentNote').value.trim();
                
                if (!amount || amount <= 0) {
                    showMessage('To\'g\'ri summa kiriting!', 'error');
                    return;
                }
                
                if (!date) {
                    showMessage('Sana tanlang!', 'error');
                    return;
                }
                
                let payments = [...appData.payments];
                
                let newId = 1;
                if (payments.length > 0) {
                    newId = Math.max(...payments.map(p => p.id)) + 1;
                }
                
                const newPayment = {
                    id: newId,
                    date: date,
                    timestamp: new Date().toISOString(),
                    type: type,
                    amount: amount,
                    note: note || `${type === 'workshop' ? 'Sex' : 'Mijoz'} qarzini to'lash`
                };
                
                if (type === 'workshop') {
                    newPayment.workshop_id = id;
                    let workshops = [...appData.workshops];
                    const workshop = workshops.find(w => w.id == id);
                    
                    if (workshop) {
                        if (amount > workshop.debt) {
                            showMessage(`To'lov summasi qarzdan ko'p! Maksimal: ${formatNumber(Math.round(workshop.debt))} so'm`, 'error');
                            return;
                        }
                        
                        workshop.total_paid = (workshop.total_paid || 0) + amount;
                        workshop.debt = Math.max(0, (workshop.debt || 0) - amount);
                        
                        await DB.save('workshops', workshops);
                        appData.workshops = workshops;
                        
                        await addActivity('payment', `${workshop.name} sexiga ${formatNumber(amount)} so'm to'lov qilindi`);
                    }
                } else if (type === 'client') {
                    newPayment.client_id = id;
                    let clients = [...appData.clients];
                    const client = clients.find(c => c.id == id);
                    
                    if (client) {
                        if (amount > client.debt) {
                            showMessage(`To'lov summasi qarzdan ko'p! Maksimal: ${formatNumber(Math.round(client.debt))} so'm`, 'error');
                            return;
                        }
                        
                        client.total_paid = (client.total_paid || 0) + amount;
                        client.debt = Math.max(0, (client.debt || 0) - amount);
                        
                        await DB.save('clients', clients);
                        appData.clients = clients;
                        
                        await addActivity('payment', `${client.name} mijozidan ${formatNumber(amount)} so'm to'lov olindi`);
                    }
                }
                
                payments.push(newPayment);
                await DB.save('payments', payments);
                appData.payments = payments;
                
                document.getElementById('debtPaymentModal').style.display = 'none';
                document.getElementById('debtPaymentAmount').value = '';
                document.getElementById('debtPaymentNote').value = '';
                
                updateDebtsPage();
                updateDashboard();
                
                if (currentUserType === 'client' && currentUser && currentUser.id == id) {
                    updateClientPage();
                }
                
                showMessage(`${formatNumber(amount)} so'm to'lov muvaffaqiyatli saqlandi!`);
            } catch (error) {
                console.error('Qarz to\'lashda xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // To'lov qilish (eski usul)
        const processPayment = async function() {
            try {
                const paymentType = document.getElementById('paymentType').value;
                const workshopId = paymentType === 'workshop' ? parseInt(document.getElementById('paymentWorkshop').value) : null;
                const clientId = paymentType === 'client' ? parseInt(document.getElementById('paymentClient').value) : null;
                const amount = parseInt(document.getElementById('paymentAmount').value);
                const date = document.getElementById('paymentDate').value;
                const note = document.getElementById('paymentNote').value.trim();
                
                if (!paymentType) {
                    showMessage('To\'lov turini tanlang!', 'error');
                    return;
                }
                
                if (paymentType === 'workshop' && !workshopId) {
                    showMessage('Sex tanlang!', 'error');
                    return;
                }
                
                if (paymentType === 'client' && !clientId) {
                    showMessage('Mijoz tanlang!', 'error');
                    return;
                }
                
                if (!amount || amount <= 0) {
                    showMessage('To\'g\'ri summa kiriting!', 'error');
                    return;
                }
                
                if (!date) {
                    showMessage('Sana tanlang!', 'error');
                    return;
                }
                
                let payments = [...appData.payments];
                
                let newId = 1;
                if (payments.length > 0) {
                    newId = Math.max(...payments.map(p => p.id)) + 1;
                }
                
                const newPayment = {
                    id: newId,
                    date: date,
                    timestamp: new Date().toISOString(),
                    type: paymentType,
                    workshop_id: workshopId,
                    client_id: clientId,
                    amount: amount,
                    note: note
                };
                
                payments.push(newPayment);
                await DB.save('payments', payments);
                appData.payments = payments;
                
                if (paymentType === 'workshop') {
                    let workshops = [...appData.workshops];
                    const workshop = workshops.find(w => w.id == workshopId);
                    
                    if (workshop) {
                        workshop.total_paid = (workshop.total_paid || 0) + amount;
                        workshop.debt = Math.max(0, (workshop.debt || 0) - amount);
                        
                        await DB.save('workshops', workshops);
                        appData.workshops = workshops;
                        
                        await addActivity('payment', `${workshop.name} sexiga ${formatNumber(amount)} so'm to'lov qilindi`);
                    }
                } else if (paymentType === 'client') {
                    let clients = [...appData.clients];
                    const client = clients.find(c => c.id == clientId);
                    
                    if (client) {
                        client.total_paid = (client.total_paid || 0) + amount;
                        client.debt = Math.max(0, (client.debt || 0) - amount);
                        
                        await DB.save('clients', clients);
                        appData.clients = clients;
                        
                        await addActivity('payment', `${client.name} mijozidan ${formatNumber(amount)} so'm to'lov olindi`);
                    }
                }
                
                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentNote').value = '';
                
                updateDebtsPage();
                updateDashboard();
                
                showMessage(`${formatNumber(amount)} so'm to'lov muvaffaqiyatli saqlandi!`);
            } catch (error) {
                console.error('To\'lov qilishda xatolik:', error);
                showMessage('Xatolik yuz berdi!', 'error');
            }
        };
        
        // Kirish funksiyasi
        const login = function() {
            const userIdInput = document.getElementById('userId').value.trim();
            const isClient = document.getElementById('clientBtn').classList.contains('active');
            const isAdmin = document.getElementById('adminBtn').classList.contains('active');
            
            document.getElementById('loginError').style.display = 'none';
            
            if (isAdmin) {
                if (userIdInput === '2') {  // PAROL O'ZGARTIRILDI: 22 -> 2
                    currentUserType = 'admin';
                    currentUser = { name: 'Admin', role: 'admin' };
                    
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('mainPage').style.display = 'block';
                    
                    document.getElementById('adminNav').style.display = 'flex';
                    document.getElementById('clientInfoCard').style.display = 'none';
                    document.getElementById('clientPage').style.display = 'none';
                    document.getElementById('dashboardPage').style.display = 'block';
                    
                    document.getElementById('currentUserType').innerHTML = '<span class="badge badge-primary">Admin</span>';
                    
                    updateDashboard();
                    
                    addActivity('login', 'Admin tizimga kirdi');
                    
                    return;
                } else {
                    document.getElementById('errorText').textContent = 'Adashlar paroni biladi';
                    document.getElementById('loginError').style.display = 'flex';
                    return;
                }
            }
            
            if (isClient) {
                if (!userIdInput || userIdInput.length !== 6 || isNaN(userIdInput)) {
                    document.getElementById('errorText').textContent = 'Iltimos, 6 xonali ID raqamini kiriting!';
                    document.getElementById('loginError').style.display = 'flex';
                    return;
                }
                
                const clientId = parseInt(userIdInput);
                
                const clients = appData.clients;
                const client = clients.find(c => c.id === clientId);
                
                if (!client) {
                    document.getElementById('errorText').textContent = 'Mijoz topilmadi! ID raqamini tekshiring.';
                    document.getElementById('loginError').style.display = 'flex';
                    return;
                }
                
                currentUserType = 'client';
                currentUser = client;
                
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainPage').style.display = 'block';
                
                document.getElementById('adminNav').style.display = 'none';
                document.getElementById('clientInfoCard').style.display = 'block';
                document.getElementById('clientPage').style.display = 'block';
                document.getElementById('dashboardPage').style.display = 'none';
                
                document.getElementById('currentUserType').innerHTML = '<span class="badge badge-success">Mijoz</span>';
                
                updateClientPage();
                
                addActivity('login', `${client.name} mijoz tizimga kirdi`);
                
                return;
            }
            
            document.getElementById('errorText').textContent = 'Iltimos, foydalanuvchi turini tanlang!';
            document.getElementById('loginError').style.display = 'flex';
        };
        
        // Chiqish funksiyasi
        const logout = function() {
            currentUser = null;
            currentUserType = null;
            
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            
            document.getElementById('userId').value = '';
            document.getElementById('loginError').style.display = 'none';
        };
        
        // Tema o'zgartirish
        const toggleTheme = function() {
            if (currentTheme === 'light') {
                currentTheme = 'dark';
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                currentTheme = 'light';
                document.body.removeAttribute('data-theme');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon"></i>';
            }
            
            localStorage.setItem('theme', currentTheme);
        };
        
        // DOM yuklanganidan so'ng
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await initializeData();
                
                // Tema yuklash
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    currentTheme = 'dark';
                    document.body.setAttribute('data-theme', 'dark');
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
                }
                
                // Bugungi sanani default qilish
                const today = new Date().toISOString().split('T')[0];
                document.querySelectorAll('input[type="date"]').forEach(input => {
                    if (!input.value) {
                        input.value = today;
                    }
                });
                
                // Foydalanuvchi turini tanlash
                document.getElementById('clientBtn').addEventListener('click', function() {
                    document.getElementById('clientBtn').classList.add('active');
                    document.getElementById('adminBtn').classList.remove('active');
                    document.getElementById('idLabel').textContent = 'Mijoz ID raqamini kiriting (6 xonali)';
                    document.getElementById('userId').placeholder = 'Masalan: 482931';
                });
                
                document.getElementById('adminBtn').addEventListener('click', function() {
                    document.getElementById('adminBtn').classList.add('active');
                    document.getElementById('clientBtn').classList.remove('active');
                    document.getElementById('idLabel').textContent = 'Sotuvchi parolini kiriting';
                    document.getElementById('userId').placeholder = '*****';
                });
                
                // Kirish tugmasi
                document.getElementById('loginButton').addEventListener('click', login);
                
                document.getElementById('userId').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
                
                // Chiqish tugmasi
                document.getElementById('logoutBtn').addEventListener('click', logout);
                
                // Navigatsiya tugmalari
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const pageId = this.getAttribute('data-page');
                        updatePage(pageId);
                    });
                });
                
                // Tab tugmalari
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const tabId = this.getAttribute('data-tab');
                        
                        this.parentElement.querySelectorAll('.tab-btn').forEach(tb => {
                            tb.classList.remove('active');
                        });
                        
                        const tabContents = this.closest('.card').querySelectorAll('.tab-content');
                        tabContents.forEach(tc => {
                            tc.classList.remove('active');
                        });
                        
                        this.classList.add('active');
                        const tabContent = document.getElementById(tabId);
                        if (tabContent) {
                            tabContent.classList.add('active');
                        }
                        
                        // Agar mijozlar tab'iga o'tilsa, uni yangilash
                        if (tabId === 'clientsListTab') {
                            setTimeout(updateClientsTab, 100);
                        }
                    });
                });
                
                // Modal yopish
                document.querySelectorAll('.close-modal, #closeMessageModal').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.getElementById('messageModal').style.display = 'none';
                    });
                });
                
                document.getElementById('messageModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
                
                // Qarz to'lov modali
                document.getElementById('cancelDebtPayment').addEventListener('click', function() {
                    document.getElementById('debtPaymentModal').style.display = 'none';
                });
                
                document.getElementById('debtPaymentModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
                
                document.getElementById('confirmDebtPayment').addEventListener('click', processDebtPayment);
                
                // Mijoz qo'shish modali
                document.getElementById('cancelAddClient').addEventListener('click', function() {
                    document.getElementById('addClientModal').style.display = 'none';
                });
                
                document.getElementById('addClientModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
                
                document.getElementById('saveModalClientBtn').addEventListener('click', addClient);
                
                // Tema tugmasi
                document.getElementById('themeToggle').addEventListener('click', toggleTheme);
                
                // Sex qo'shish tugmasi
                document.getElementById('addWorkshopBtn').addEventListener('click', addWorkshop);
                
                // Kirim qo'shish tugmasi
                document.getElementById('addIncomeBtn').addEventListener('click', addIncome);
                
                // Yangi mijoz tugmasi (modal ochish)
                document.getElementById('newClientBtn').addEventListener('click', function() {
                    document.getElementById('modalClientName').value = '';
                    document.getElementById('modalClientPhone').value = '';
                    document.getElementById('addClientModal').style.display = 'flex';
                });
                
                // Mijoz qo'shish tugmasi (tab ichidagi)
                document.getElementById('saveNewClientBtn').addEventListener('click', addClientFromTab);
                
                // Sotuv qo'shish tugmasi
                document.getElementById('addSaleBtn').addEventListener('click', addSale);
                
                // Brak qaydnomasi tugmasi
                document.getElementById('processDefectBtn').addEventListener('click', processDefect);
                
                // Sexga qaytarish tugmasi
                document.getElementById('processReturnToWorkshopBtn').addEventListener('click', processReturnToWorkshop);
                
                // To'lov qilish tugmasi
                document.getElementById('processPaymentBtn').addEventListener('click', processPayment);
                
                // To'lov turini o'zgartirganda
                const paymentTypeSelect = document.getElementById('paymentType');
                if (paymentTypeSelect) {
                    paymentTypeSelect.addEventListener('change', function() {
                        const type = this.value;
                        
                        if (type === 'workshop') {
                            document.getElementById('paymentWorkshopGroup').style.display = 'block';
                            document.getElementById('paymentClientGroup').style.display = 'none';
                        } else if (type === 'client') {
                            document.getElementById('paymentWorkshopGroup').style.display = 'none';
                            document.getElementById('paymentClientGroup').style.display = 'block';
                        } else {
                            document.getElementById('paymentWorkshopGroup').style.display = 'none';
                            document.getElementById('paymentClientGroup').style.display = 'none';
                        }
                    });
                }
                
                // Sexga qaytarishda mahsulot turini tanlanganda maksimal miqdorni ko'rsatish
                const returnToWorkshopProductSelect = document.getElementById('returnToWorkshopProduct');
                if (returnToWorkshopProductSelect) {
                    returnToWorkshopProductSelect.addEventListener('change', function() {
                        const productKey = this.value;
                        
                        if (!productKey) {
                            document.getElementById('maxReturnToWorkshopQuantity').textContent = '0 dona';
                            return;
                        }
                        
                        const storage = appData.storage;
                        const storageItem = storage.find(item => item.key === productKey);
                        
                        if (storageItem) {
                            document.getElementById('maxReturnToWorkshopQuantity').textContent = storageItem.defects + ' dona';
                        } else {
                            document.getElementById('maxReturnToWorkshopQuantity').textContent = '0 dona';
                        }
                    });
                }
                
                // Halat turi tanlanganda ombor qoldig'ini ko'rsatish
                const saleProductTypeSelect = document.getElementById('saleProductType');
                if (saleProductTypeSelect) {
                    saleProductTypeSelect.addEventListener('change', function() {
                        const productType = this.value;
                        
                        if (!productType) {
                            document.getElementById('productStockInfo').textContent = '0 dona';
                            return;
                        }
                        
                        const storage = appData.storage;
                        const storageItem = storage.find(item => item.key === productType);
                        
                        if (storageItem) {
                            document.getElementById('productStockInfo').textContent = storageItem.current_balance + ' dona';
                        } else {
                            document.getElementById('productStockInfo').textContent = '0 dona';
                        }
                    });
                }
                
                // Sotuv hisobotini yangilash
                const updateSaleReport = function() {
                    const quantity = parseInt(document.getElementById('saleQuantity').value) || 0;
                    const pricePerUnit = parseInt(document.getElementById('salePrice').value) || 0;
                    const paid = parseInt(document.getElementById('salePaid').value) || 0;
                    
                    const totalAmount = quantity * pricePerUnit;
                    const debt = totalAmount - paid;
                    
                    const productType = document.getElementById('saleProductType').value;
                    let estimatedProfit = 0;
                    
                    if (productType) {
                        const storage = appData.storage;
                        const storageItem = storage.find(item => item.key === productType);
                        
                        if (storageItem) {
                            const avgCost = storageItem.avg_price || 0;
                            estimatedProfit = (pricePerUnit - avgCost) * quantity;
                        }
                    }
                    
                    document.getElementById('saleTotalQuantity').textContent = formatNumber(quantity) + ' dona';
                    document.getElementById('saleTotalAmount').textContent = formatNumber(Math.round(totalAmount)) + ' so`m';
                    document.getElementById('saleTotalPaid').textContent = formatNumber(Math.round(paid)) + ' so`m';
                    document.getElementById('saleTotalDebt').textContent = formatNumber(Math.round(debt)) + ' so`m';
                    document.getElementById('saleEstimatedProfit').textContent = formatNumber(Math.round(estimatedProfit)) + ' so`m';
                };
                
                const saleQuantityInput = document.getElementById('saleQuantity');
                const salePriceInput = document.getElementById('salePrice');
                const salePaidInput = document.getElementById('salePaid');
                
                if (saleQuantityInput) saleQuantityInput.addEventListener('input', updateSaleReport);
                if (salePriceInput) salePriceInput.addEventListener('input', updateSaleReport);
                if (salePaidInput) salePaidInput.addEventListener('input', updateSaleReport);
                
                // Global funksiyalarni window obyektiga qo'shish
                window.editWorkshop = editWorkshop;
                window.deleteWorkshop = deleteWorkshop;
                window.editClient = editClient;
                window.deleteClient = deleteClient;
                window.deleteSale = deleteSale;
                window.deleteReturn = deleteReturn;
                window.deleteIncome = deleteIncome;
                window.showDebtPaymentModal = showDebtPaymentModal;
                
                console.log('Halat Savdosi Tizimi yuklandi. Versiya: 6.0 (Firebase bilan)');
                console.log('Tizim mobil qurilmalar uchun moslashtirildi. Admin paroli: 2');
                console.log('Ma\'lumotlar Firebase\'da saqlanadi - barcha qurilmalardan kirganda bir xil ma\'lumotlar ko\'rinadi');
                console.log('Firebase Realtime Database ishlatilmoqda');
                
                // Oflayn ma'lumotlarni sinxronlash
                setTimeout(() => {
                    DB.syncOfflineData();
                }, 3000);
                
            } catch (error) {
                console.error('Dasturni yuklashda xatolik:', error);
                showMessage('Dasturni yuklashda xatolik yuz berdi! Iltimos, sahifani yangilang.', 'error');
            }
        });
    </script>
</body>
</html>
